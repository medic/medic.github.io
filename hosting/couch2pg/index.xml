<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Community Health Toolkit â€“ couch2pg</title><link>https://docs.communityhealthtoolkit.org/hosting/couch2pg/</link><description>Recent content in couch2pg on Community Health Toolkit</description><generator>Hugo -- gohugo.io</generator><language>en</language><atom:link href="https://docs.communityhealthtoolkit.org/hosting/couch2pg/index.xml" rel="self" type="application/rss+xml"/><item><title>Setup and Development</title><link>https://docs.communityhealthtoolkit.org/hosting/couch2pg/setup-and-devlopment/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/hosting/couch2pg/setup-and-devlopment/</guid><description>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-amber-200 hx:bg-amber-100 hx:text-amber-900 hx:dark:border-amber-200/30 hx:dark:bg-amber-900/30 hx:dark:text-amber-200"&gt;
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2"&gt;&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/&gt;&lt;/svg&gt;&lt;/div&gt;
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7"&gt;
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0"&gt;CHT couch2pg is deprecated. For data synchronization, refer to &lt;a href="https://docs.communityhealthtoolkit.org/hosting/analytics/"target="_blank" rel="noopener"&gt;CHT Sync&lt;/a&gt;.&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Create read-only replicas of CouchDB data inside PostgresSQL.&lt;/p&gt;
&lt;p&gt;The focus is specifically on &lt;a href="https://github.com/medic/cht-core"target="_blank" rel="noopener"&gt;CHT&lt;/a&gt; application data currently stored in CouchDB. If you are looking to have a read-only replica of CouchDB data for your application that isn&amp;rsquo;t the CHT, consider &lt;a href="https://www.npmjs.com/package/couch2pg"target="_blank" rel="noopener"&gt;couch2pg&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This version is built for medic/cht-core#3.0.0 and above. For replicating data from earlier versions, see the 2.0.x branch and associated tags.&lt;/p&gt;
&lt;h2&gt;Prerequisites&lt;span class="hx:absolute hx:-mt-20" id="prerequisites"&gt;&lt;/span&gt;
&lt;a href="#prerequisites" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;Clone&lt;span class="hx:absolute hx:-mt-20" id="clone"&gt;&lt;/span&gt;
&lt;a href="#clone" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;All steps below require you to have a local clone of the repo.&lt;/p&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;git clone https://github.com/medic/cht-couch2pg.git&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h3&gt;Node and npm&lt;span class="hx:absolute hx:-mt-20" id="node-and-npm"&gt;&lt;/span&gt;
&lt;a href="#node-and-npm" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;You will need to install the following to run locally, but not for docker:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://nodejs.org"target="_blank" rel="noopener"&gt;Node.js&lt;/a&gt; 8.11.x up to 12.x.x. Must be an LTS release. LTS is designated with an even major version number.&lt;/li&gt;
&lt;li&gt;&lt;a href="https://npmjs.com/"target="_blank" rel="noopener"&gt;npm&lt;/a&gt; 6.x.x above&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;NOTE:&lt;/em&gt; Currently, cht-couch2pg only runs in node versions 8, 10 and 12. Later versions of node have been known to fail.&lt;/p&gt;
&lt;h3&gt;Database setup&lt;span class="hx:absolute hx:-mt-20" id="database-setup"&gt;&lt;/span&gt;
&lt;a href="#database-setup" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;code&gt;cht-couch2pg&lt;/code&gt; supports PostgreSQL 9.4 and greater. The user passed in &lt;code&gt;POSTGRESQL_URL&lt;/code&gt; needs to have full creation rights on the database in &lt;code&gt;POSTGRES_DB_NAME&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;Running&lt;span class="hx:absolute hx:-mt-20" id="running"&gt;&lt;/span&gt;
&lt;a href="#running" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;Locally with environment variables&lt;span class="hx:absolute hx:-mt-20" id="locally-with-environment-variables"&gt;&lt;/span&gt;
&lt;a href="#locally-with-environment-variables" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;&lt;code&gt;cd&lt;/code&gt; into it this repo&amp;rsquo;s directory where you cloned it.&lt;/li&gt;
&lt;li&gt;Install dependencies:
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;npm ci&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;Export these four variables with the values you need.:
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;POSTGRESQL_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;postgres://postgres:postgres@localhost:15432/postgres
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCHDB_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;https://admin:pass@localhost:5984/medic
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCH2PG_DOC_LIMIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCH2PG_RETRY_COUNT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;Run: &lt;code&gt;node .&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;If you want to set and save all possible variables:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;cd&lt;/code&gt; into it this repo&amp;rsquo;s directory where you cloned it.&lt;/li&gt;
&lt;li&gt;Copy &lt;code&gt;sample.env&lt;/code&gt; to &lt;code&gt;couch2pg.env&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Edit &lt;code&gt;couch2pg.env&lt;/code&gt; to have all the variables you need. Note that &lt;code&gt;POSTGRESQL_URL&lt;/code&gt; shouldn&amp;rsquo;t be edited as it&amp;rsquo;s defined by the variables above it. Be sure to change &lt;code&gt;POSTGRES_SERVER_NAME&lt;/code&gt; to where ever your postgress server is running. If it&amp;rsquo;s local, then use &lt;code&gt;localost&lt;/code&gt;. The default value of &lt;code&gt;postgres&lt;/code&gt; won&amp;rsquo;t work.&lt;/li&gt;
&lt;li&gt;Run: &lt;code&gt;. ./couch2pg.env&amp;amp;&amp;amp;node .&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;In docker-compose&lt;span class="hx:absolute hx:-mt-20" id="in-docker-compose"&gt;&lt;/span&gt;
&lt;a href="#in-docker-compose" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The simplest way to run with &lt;code&gt;docker-compose&lt;/code&gt; is to specify the CouchDB instance that your CHT is using. The compose file will then create a dockerized PostgresSQL instance, connect to the CouchDB server and proceed to download all the data to the PostgresSQL instance:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;cd&lt;/code&gt; into it this repo&amp;rsquo;s directory where you cloned it.&lt;/li&gt;
&lt;li&gt;When starting the docker compose services, you need to set the URL for CouchDB in the &lt;code&gt;COUCHDB_URL&lt;/code&gt; env variable. This URL needs to be reachable the docker container (ie not &lt;code&gt;localhost&lt;/code&gt;). Ensuring you&amp;rsquo;re in the same directory where you ran the &lt;code&gt;curl&lt;/code&gt; call in the prior step, run:
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCHDB_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;https://medic:password@192-168-68-26.my.local-ip.co:8442/medic
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;docker-compose up&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;Connect to the PostgresSQL instance with login &lt;code&gt;cht_couch2pg&lt;/code&gt;, password &lt;code&gt;cht_couch2pg_password&lt;/code&gt; and database &lt;code&gt;cht&lt;/code&gt;. As these are insecure, do not use with production data. See below for how to harden these.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;If you want to set all possible variables, or be able to store the variables in configuration file:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;cd&lt;/code&gt; into it this repo&amp;rsquo;s directory where you cloned it.&lt;/li&gt;
&lt;li&gt;Copy &lt;code&gt;sample.env&lt;/code&gt; to &lt;code&gt;couch2pg.env&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Edit &lt;code&gt;couch2pg.env&lt;/code&gt; to have all the variables you need. Note that &lt;code&gt;POSTGRESQL_URL&lt;/code&gt; shouldn&amp;rsquo;t be edited as it&amp;rsquo;s defined by the variables above it. If you&amp;rsquo;re using the built-in PostgresSQL server, be sure to keep the &lt;code&gt;POSTGRES_SERVER_NAME&lt;/code&gt; set to &lt;code&gt;postgres&lt;/code&gt; as this is the correct internal service name in docker. Be sure to also set secure passwords for all PostgresSQL accounts.&lt;/li&gt;
&lt;li&gt;Run docker and specify the environment file you just edited:
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;docker-compose --env-file couch2pg.env up&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;To connect to the PostgresSQL instance, use the server from &lt;code&gt;POSTGRES_SERVER_NAME&lt;/code&gt;, use login from &lt;code&gt;COUCH2PG_USER&lt;/code&gt;, password from &lt;code&gt;COUCH2PG_USER_PASSWORD&lt;/code&gt; and the database from &lt;code&gt;POSTGRES_DB_NAME&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Interactive&lt;span class="hx:absolute hx:-mt-20" id="interactive"&gt;&lt;/span&gt;
&lt;a href="#interactive" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Run it locally in interactive mode with &lt;code&gt;node . -i&lt;/code&gt; and you will see the ASCII art:&lt;/p&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ____ _ _ _____ ____ _ ____ ____
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; / ___&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_ _&lt;span class="p"&gt;|&lt;/span&gt; / ___&lt;span class="p"&gt;|&lt;/span&gt; ___ _ _ ___ &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;__ &lt;span class="p"&gt;|&lt;/span&gt;___ &lt;span class="se"&gt;\ &lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; _ &lt;span class="se"&gt;\ &lt;/span&gt; __ _
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; _____ &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; / _ &lt;span class="se"&gt;\ &lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; / __&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="err"&gt;&amp;#39;&lt;/span&gt;_ &lt;span class="se"&gt;\ &lt;/span&gt; __&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; / _&lt;span class="sb"&gt;`&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;___ &lt;span class="p"&gt;|&lt;/span&gt; _ &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_____&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;___ &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;_&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;__ &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; / __/ &lt;span class="p"&gt;|&lt;/span&gt; __/ &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="se"&gt;\_&lt;/span&gt;___&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="se"&gt;\_&lt;/span&gt;___&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="se"&gt;\_&lt;/span&gt;__/ &lt;span class="se"&gt;\_&lt;/span&gt;_,_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="se"&gt;\_&lt;/span&gt;__&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_____&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;_&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="se"&gt;\_&lt;/span&gt;_, &lt;span class="p"&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;|&lt;/span&gt;___/ &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Instead of environment variables, you will be prompted to answer the following questions. For each question, you will be given suggestions for an answer:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Enter CHT&amp;rsquo;s couch url&lt;/li&gt;
&lt;li&gt;Enter cht-couch2pg postgres url&lt;/li&gt;
&lt;li&gt;Select the number of minutes interval between checking for updates&lt;/li&gt;
&lt;li&gt;Select the number of documents to grab concurrently. Increasing this number will cut down on HTTP GETs and may improve performance, decreasing this number will cut down on node memory usage, and may increase stability.&lt;/li&gt;
&lt;li&gt;Select the number of document ids to grab per change limit request. Increasing this number will cut down on HTTP GETs and may improve performance, decreasing this number will cut down on node memory usage slightly, and may increase stability.&lt;/li&gt;
&lt;li&gt;Select whether or not to have verbose logging.&lt;/li&gt;
&lt;li&gt;Select how many times to internally retry continued unsuccessful runs before exiting. If unset cht-couch2pg will retry indefinitely. If set it will retry N times, and then exit with status code 1 indefinitely&lt;/li&gt;
&lt;li&gt;Select the number of documents to grab concurrently from the users-meta database. Increasing this number will cut down on HTTP GETs and may improve performance, decreasing this number will cut down on node memory usage, and may increase stability. These documents are larger so set a limit lower than the docLimit&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Supported environment variables&lt;span class="hx:absolute hx:-mt-20" id="supported-environment-variables"&gt;&lt;/span&gt;
&lt;a href="#supported-environment-variables" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;All three methods of running cht-couch2pg listed above use these variables:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;COUCHDB_URL&lt;/code&gt; - CouchDB instance URL with no trailing slash after &lt;code&gt;/medic&lt;/code&gt;, format: &lt;code&gt;https://[user]:[password]@localhost:[port]/medic&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;COUCH2PG_SLEEP_MINS&lt;/code&gt; - Number of minutes between synchronization. It defaults to &lt;code&gt;60&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;COUCH2PG_DOC_LIMIT&lt;/code&gt; - Number of documents cht-couch2pg fetches from CouchDB everytime. Suggested: &lt;code&gt;1000&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;COUCH2PG_RETRY_COUNT&lt;/code&gt; - Number of times cht-couch2pg will retry synchronizing documents from CouchDB after experiencing an error&lt;/li&gt;
&lt;li&gt;&lt;code&gt;COUCH2PG_USERS_META_DOC_LIMIT&lt;/code&gt; - Number of documents to grab concurrently from the users-meta database. These documents are larger so set a limit lower than the docLimit. It defaults to &lt;code&gt;50&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;COUCH2PG_CHANGES_LIMIT&lt;/code&gt; - The number of document ids to fetch per change limit request. Suggested: &lt;code&gt;100&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;COUCH2PG_USER&lt;/code&gt; - The user that couch2pg will use to login in to the CouchDB server. Suggested &lt;code&gt;cht_couch2pg&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;COUCH2PG_USER_PASSWORD&lt;/code&gt; - The password that couch2pg will use to login in to the CouchDB server.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;POSTGRES_SERVER_NAME&lt;/code&gt; - The server or IP where the postgres server is. This should be set to &lt;code&gt;postgres&lt;/code&gt; when using docker.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;POSTGRES_USER_NAME&lt;/code&gt; - The admin user for postgres in docker. Suggested: &lt;code&gt;postgres_root&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;POSTGRES_PASSWORD&lt;/code&gt; - The admin password for postgres in docker.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;POSTGRES_DB_NAME&lt;/code&gt; - The name of the PostgreSQL database to sync to.. Suggested: &lt;code&gt;cht&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;POSTGRES_PORT&lt;/code&gt; - Port where PostgresSQL can be found. Suggested: &lt;code&gt;5432&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;POSTGRESQL_URL&lt;/code&gt; - PostgresSQL instance URL, format: &lt;code&gt;postgres://[user]:[password]@localhost:[port]/[database name]&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SYNC_DB_MEDIC&lt;/code&gt; - Whether to sync the content of the &lt;code&gt;medic&lt;/code&gt; database. Suggested: &lt;code&gt;true&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SYNC_DB_SENTINEL&lt;/code&gt; - Whether to sync the content of the &lt;code&gt;medic-sentinel&lt;/code&gt; database. Suggested: &lt;code&gt;true&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SYNC_DB_USER_META&lt;/code&gt; - Whether to sync the content of the &lt;code&gt;medic-users-meta&lt;/code&gt; database. Suggested: &lt;code&gt;true&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SYNC_DB_LOGS&lt;/code&gt; - Whether to sync the content of &lt;code&gt;medic-logs&lt;/code&gt; database. Suggested: &lt;code&gt;true&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SYNC_DB_USERS&lt;/code&gt; - Whether to sync the CouchDB &lt;code&gt;_users&lt;/code&gt; database without security information. Suggested: &lt;code&gt;true&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Known issues&lt;span class="hx:absolute hx:-mt-20" id="known-issues"&gt;&lt;/span&gt;
&lt;a href="#known-issues" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;Error &amp;ldquo;Checksum failed for migration &amp;hellip;&amp;rdquo; when upgrading from 3.2.0 to latest&lt;span class="hx:absolute hx:-mt-20" id="error-checksum-failed-for-migration--when-upgrading-from-320-to-latest"&gt;&lt;/span&gt;
&lt;a href="#error-checksum-failed-for-migration--when-upgrading-from-320-to-latest" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;An SQL migration file was changed in version 3.2.0. This made upgrades from 3.1.x impossible, with the process crashing upon startup after the upgrade. See more &lt;a href="https://github.com/medic/cht-couch2pg/issues/78"target="_blank" rel="noopener"&gt;details about the error&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This was fixed in version 3.2.1, by reverting the changes made to the migration file.
Fresh installations of 3.2.0 should execute this SQL before upgrading:&lt;/p&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;UPDATE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;xmlforms_migrations&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SET&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;md5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;e0535c9fe3faef6e66a31691deebf1a8&amp;#39;&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;WHERE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;version&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;201606200952&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;AND&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;md5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;40187aa5ee95eda0e154ecefd7512cda&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;See more details about the error in &lt;a href="https://github.com/medic/cht-couch2pg/issues/78"target="_blank" rel="noopener"&gt;#78&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;Error installing deps &lt;code&gt;ERR! ... node-pre-gyp install --fallback-to-build&lt;/code&gt;&lt;span class="hx:absolute hx:-mt-20" id="error-installing-deps-err--node-pre-gyp-install---fallback-to-build"&gt;&lt;/span&gt;
&lt;a href="#error-installing-deps-err--node-pre-gyp-install---fallback-to-build" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;When installing Node.js dependencies locally or building the docker image, you might get an error like:&lt;/p&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;npm ERR! code ELIFECYCLE
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;npm ERR! errno &lt;span class="m"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;npm ERR! node-libcurl@1.3.3 install: &lt;span class="sb"&gt;`&lt;/span&gt;node-pre-gyp install --fallback-to-build&lt;span class="sb"&gt;`&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;It is probably related to a gcc library that is failing with some versions of Node and npm, try with Node 10 without updating the &lt;code&gt;npm&lt;/code&gt; version that comes with it.&lt;/p&gt;
&lt;h2&gt;Tests&lt;span class="hx:absolute hx:-mt-20" id="tests"&gt;&lt;/span&gt;
&lt;a href="#tests" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Run tests with docker-compose:&lt;/p&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;docker-compose -f docker-compose.test.yml build cht-couch2pg
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;docker-compose -f docker-compose.test.yml run cht-couch2pg grunt test&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Run tests in interactive watch mode with: &lt;code&gt;docker-compose -f docker-compose.test.yml run cht-couch2pg npm run watch&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Run entrypoint script tests with&lt;/p&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;docker-compose -f docker-compose.test.yml run cht-couch2pg ./tests/bash/bats/bin/bats /app/tests/bash/test.bats&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;Releasing&lt;span class="hx:absolute hx:-mt-20" id="releasing"&gt;&lt;/span&gt;
&lt;a href="#releasing" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;Create a pull request with prep for the new release.&lt;/li&gt;
&lt;li&gt;Get the pull request reviewed and approved.&lt;/li&gt;
&lt;li&gt;When doing the squash and merge, make sure that your commit message is clear and readable and follows the strict format described in the commit format section below. If the commit message does not comply, automatic release will fail.&lt;/li&gt;
&lt;li&gt;In case you are planning to merge the pull request with a merge commit, make sure that every commit in your branch respects the format.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Commit format&lt;span class="hx:absolute hx:-mt-20" id="commit-format"&gt;&lt;/span&gt;
&lt;a href="#commit-format" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The commit format should follow this &lt;a href="https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-angular"target="_blank" rel="noopener"&gt;conventional-changelog angular preset&lt;/a&gt;. Examples are provided below.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Type&lt;/th&gt;
&lt;th&gt;Example commit message&lt;/th&gt;
&lt;th&gt;Release type&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Bug fixes&lt;/td&gt;
&lt;td&gt;fix(#123): infinite loop when materialized views doesn&amp;rsquo;t exist&lt;/td&gt;
&lt;td&gt;patch&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Performance&lt;/td&gt;
&lt;td&gt;perf(#789): Refresh materialized views faster&lt;/td&gt;
&lt;td&gt;patch&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Features&lt;/td&gt;
&lt;td&gt;feat(#456): Support real-time sync&lt;/td&gt;
&lt;td&gt;minor&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Non-code&lt;/td&gt;
&lt;td&gt;chore(#123): update README&lt;/td&gt;
&lt;td&gt;none&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Breaking&lt;/td&gt;
&lt;td&gt;perf(#2): remove support for pg 7 &lt;br/&gt; BREAKING CHANGE: postgres 7 no longer supported&lt;/td&gt;
&lt;td&gt;major&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;</description></item><item><title>Migration</title><link>https://docs.communityhealthtoolkit.org/hosting/couch2pg/migration/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/hosting/couch2pg/migration/</guid><description>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-amber-200 hx:bg-amber-100 hx:text-amber-900 hx:dark:border-amber-200/30 hx:dark:bg-amber-900/30 hx:dark:text-amber-200"&gt;
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2"&gt;&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/&gt;&lt;/svg&gt;&lt;/div&gt;
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7"&gt;
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0"&gt;CHT couch2pg is deprecated. For data synchronization, refer to &lt;a href="https://docs.communityhealthtoolkit.org/hosting/analytics/"target="_blank" rel="noopener"&gt;CHT Sync&lt;/a&gt;.&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;Assumptions &amp;amp; Prerequisites&lt;span class="hx:absolute hx:-mt-20" id="assumptions--prerequisites"&gt;&lt;/span&gt;
&lt;a href="#assumptions--prerequisites" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This guide assumes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Your CHT instance set up.&lt;/li&gt;
&lt;li&gt;Your Postgres server is set up. We&amp;rsquo;ll be using &lt;code&gt;10.195.130.93&lt;/code&gt; in this documentation, but be sure to use your production Postgres address. The server needs to have &lt;code&gt;pg_dump&lt;/code&gt; command available.&lt;/li&gt;
&lt;li&gt;Your CHT couch2pg (aka couch2pg) instance is set up. In this guide, we&amp;rsquo;ll assume it&amp;rsquo;s on the same server as the Postgres instance.&lt;/li&gt;
&lt;li&gt;You want to move both couch2pg instance and the Postgres data to a new server&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Further, be sure you meet the following prerequisites:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Have provisioned a new Postgres server. The server needs to have &lt;code&gt;pg_restore&lt;/code&gt; command available.&lt;/li&gt;
&lt;li&gt;Have access to existing Postgres server to be able to dump the data&lt;/li&gt;
&lt;li&gt;Have access to couch2pg instance, including the CHT Core credentials it&amp;rsquo;s using&lt;/li&gt;
&lt;li&gt;Have 3x the disk space as your data on both the old and new server - see below&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; If you don&amp;rsquo;t mind waiting and don&amp;rsquo;t want to deal with the trouble of copying large data files around as documented on this page, it will be easier to set up a clean &lt;a href="https://docs.communityhealthtoolkit.org/hosting/couch2pg/setup-and-devlopment/"&gt;install of couch2pg&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Time to copy&lt;span class="hx:absolute hx:-mt-20" id="time-to-copy"&gt;&lt;/span&gt;
&lt;a href="#time-to-copy" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Copying and loading large amounts of Postgres data can take a long time. If you make a mistake, going back to the first step can take more time. Don&amp;rsquo;t plan a production migration without doing at least one dry run! Do more dry runs until your confident that everything works as expected.&lt;/p&gt;
&lt;p&gt;Consider keeping your old couch2pg system running alongside your new one. This will allow you to fail over to the old one easily and it will be up to date with data from your CHT instance. It is safe to run multiple couch2pg instances against the same CHT instance.&lt;/p&gt;
&lt;p&gt;When you&amp;rsquo;re confident the new system is up and running, is stable and performant, go ahead and decommission the old system.&lt;/p&gt;
&lt;h3&gt;Disk space prerequisites&lt;span class="hx:absolute hx:-mt-20" id="disk-space-prerequisites"&gt;&lt;/span&gt;
&lt;a href="#disk-space-prerequisites" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;You need 3 times the database size of free disk space on both the old and new Postgres servers. The 3x number comes from 3 sources of data:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Existing Postgres database&lt;/li&gt;
&lt;li&gt;Dump of this same data via &lt;code&gt;pg_dump&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;making a compressed copy with &lt;code&gt;gzip&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;While you may not fully need all of 3x the disk space, having the extra space will be important to ensure you don&amp;rsquo;t accidentally fill up the disk on a production instance.&lt;/p&gt;
&lt;p&gt;For example, on a Postgres server with &lt;code&gt;400GB&lt;/code&gt; disk with millions of documents in Postgres:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;175GB&lt;/code&gt; - Existing Postgres database&lt;/li&gt;
&lt;li&gt;&lt;code&gt;175GB&lt;/code&gt; - Dump of this same data via &lt;code&gt;pg_dump&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;~&lt;code&gt;60GB&lt;/code&gt; - making a compressed copy with &lt;code&gt;gzip&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The server is healthy woth just over 40% of the disk used day to day. However, if you make a copy of the data (&lt;code&gt;175GB&lt;/code&gt; + &lt;code&gt;175GB&lt;/code&gt; = &lt;code&gt;350GB&lt;/code&gt;), you now have the disk over 85% full with only 50GB free. You very likely will not have room to compress the data (&lt;code&gt;175GB&lt;/code&gt; + &lt;code&gt;175GB&lt;/code&gt; + &lt;code&gt;60GB&lt;/code&gt; = &lt;code&gt;410GB&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;The best work around is to increase the size of your Postgres server assuming you&amp;rsquo;re on a cloud provider that offers this. Another work around can be to run &lt;code&gt;pg_dump&lt;/code&gt; from another computer with more disk space, but note that this will send the uncompressed data over the network which may take a long time. The same is true doing the restore over the network - it will be much slower than if you did it locally.&lt;/p&gt;
&lt;p&gt;To show disk use of all databases, run this command, being sure to replace &lt;code&gt;couch2pg&lt;/code&gt; with your user:&lt;/p&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;psql -U couch2pg -c &lt;span class="s1"&gt;&amp;#39;\l+&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;Instructions&lt;span class="hx:absolute hx:-mt-20" id="instructions"&gt;&lt;/span&gt;
&lt;a href="#instructions" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;Current Postgres data and couch2pg config&lt;span class="hx:absolute hx:-mt-20" id="current-postgres-data-and-couch2pg-config"&gt;&lt;/span&gt;
&lt;a href="#current-postgres-data-and-couch2pg-config" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;SSH to your postgres server&lt;/li&gt;
&lt;li&gt;Connect to the &lt;code&gt;cht&lt;/code&gt; database and run this query:
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;select&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;count&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;from&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;couchdb&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
We&amp;rsquo;ll use this in the next server to validate data was imported. On large datasets this may take a long while to run.&lt;/li&gt;
&lt;li&gt;Create a tarball of your database. This assumes you&amp;rsquo;re using the default &lt;code&gt;cht&lt;/code&gt; name for your database with a username of &lt;code&gt;couch2pg&lt;/code&gt;. Replace with your database and username if they&amp;rsquo;re different:
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;pg_dump -U couch2pg -d cht -F tar -f couch2pg.tar
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;gzip couch2pg.tar&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;strong&gt;Note&lt;/strong&gt; - If you get errors like &lt;code&gt;query failed: ERROR: permission denied&lt;/code&gt; - run this command as the &lt;code&gt;postgres&lt;/code&gt; user.&lt;/li&gt;
&lt;li&gt;Check the size of the gzip - we&amp;rsquo;ll use this in the next section: &lt;code&gt;ls -al couch2pg.tar.gz&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Copy the resulting &lt;code&gt;couch2pg.tar.gz&lt;/code&gt; file to your computer - &lt;code&gt;scp&lt;/code&gt; is good for this!&lt;/li&gt;
&lt;li&gt;Check the values for all the environment variables for couch2pg. For example, here&amp;rsquo;s what our current couch2pg has for it&amp;rsquo;s config. In our case the &lt;code&gt;POSTGRESQL_URL&lt;/code&gt; is &lt;code&gt;localhost&lt;/code&gt; because we&amp;rsquo;re on the same server as the Postgres server. Be sure to use &lt;code&gt;POSTGRESQL_URL&lt;/code&gt; and &lt;code&gt;COUCHDB_URL&lt;/code&gt; that match your deployment:
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;POSTGRESQL_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;postgres://couch2pg:passwordHere1@localhost:5432/cht
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;COUCHDB_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;https://medic:passwordHere2@192-168-68-23.local-ip.medicmobile.org:10443/medic
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;COUCH2PG_SLEEP_MINS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;360&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;COUCH2PG_DOC_LIMIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;100&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;COUCH2PG_CHANGES_LIMIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;5000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;COUCH2PG_RETRY_COUNT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;COUCH2PG_USERS_META_DOC_LIMIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;50&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;New Postgres server and couch2pg instance&lt;span class="hx:absolute hx:-mt-20" id="new-postgres-server-and-couch2pg-instance"&gt;&lt;/span&gt;
&lt;a href="#new-postgres-server-and-couch2pg-instance" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;Copy the &lt;code&gt;couch2pg.tar.gz&lt;/code&gt; file to the new Postgres server&lt;/li&gt;
&lt;li&gt;SSH to the new Postgres server&lt;/li&gt;
&lt;li&gt;Make sure the gzip&amp;rsquo;s bytes on disk exactly match the one from step 4 in the prior section: &lt;code&gt;ls -al couch2pg.tar.gz&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Uncompress the file: &lt;code&gt;gunzip couch2pg.tar.gz&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Ensure your have a &lt;code&gt;cht&lt;/code&gt; database already created on your new Postgres instance: &lt;code&gt;CREATE DATABASE cht;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Stop &lt;code&gt;couch2pg&lt;/code&gt; if it is running&lt;/li&gt;
&lt;li&gt;Load the data from the dump file, again be sure to use the current user if &lt;code&gt;couch2pg&lt;/code&gt; is the same for you:
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;pg_restore -U couch2pg -d cht couch2pg.tar&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;Connect to the &lt;code&gt;cht&lt;/code&gt; database and run this query:
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;select&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;count&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;from&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;couchdb&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
This should match the same number as on step 2 above. On large datasets this may take a long while to run.&lt;/li&gt;
&lt;li&gt;Start couch2pg, being sure to use the exact same environment variables as step 6 above, but possibly with different &lt;code&gt;POSTGRES_*&lt;/code&gt; values if they&amp;rsquo;ve changed for the new Postgres server&lt;/li&gt;
&lt;li&gt;Check the logs of couch2pg and ensure there&amp;rsquo;s no errors.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Dashboards&lt;span class="hx:absolute hx:-mt-20" id="dashboards"&gt;&lt;/span&gt;
&lt;a href="#dashboards" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Check the logs of couch2pg. Be sure there&amp;rsquo;s no errors and that materialized views are updating as expected. Complex materialized views can take hours to update. Don&amp;rsquo;t hesitate to let multiple periods of &lt;code&gt;COUCH2PG_SLEEP_MINS&lt;/code&gt; (how frequently couch2pg runs) pass to ensure no errors occur.&lt;/p&gt;
&lt;p&gt;Double check data is synchronizing by running a SQL query one of your dashboards uses. Make sure the data is both accurate and up to date. When you are confident the data is valid and working correctly, change any downstream sources, like Superset or Klipfolio, to use the new Postgres server IP and credentials&lt;/p&gt;
&lt;p&gt;If at a later date you find there&amp;rsquo;s substantial errors, you can always change your downstream sources back to using the old Postgres server and attempt the migration again, fixing errors where needed.&lt;/p&gt;
&lt;h3&gt;Cleanup&lt;span class="hx:absolute hx:-mt-20" id="cleanup"&gt;&lt;/span&gt;
&lt;a href="#cleanup" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;When you&amp;rsquo;re 100% sure the migration was successful - don&amp;rsquo;t rush this part! - be sure to clean up file, servers and services that may still be running:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Delete any &lt;code&gt;*.tar&lt;/code&gt; and &lt;code&gt;*.tar.gz&lt;/code&gt; files on the old Postgres server, on your computer and on the new Postgres server&lt;/li&gt;
&lt;li&gt;Stop couch2pg running on the old service&lt;/li&gt;
&lt;li&gt;If the data is truly not needed, drop the &lt;code&gt;cht&lt;/code&gt; database on the old Postgres server&lt;/li&gt;
&lt;li&gt;Delete any backups of the old server and service&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Local couch2pg Setup</title><link>https://docs.communityhealthtoolkit.org/hosting/couch2pg/couch2pg-setup/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/hosting/couch2pg/couch2pg-setup/</guid><description>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-amber-200 hx:bg-amber-100 hx:text-amber-900 hx:dark:border-amber-200/30 hx:dark:bg-amber-900/30 hx:dark:text-amber-200"&gt;
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2"&gt;&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/&gt;&lt;/svg&gt;&lt;/div&gt;
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7"&gt;
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0"&gt;CHT couch2pg is deprecated. For data synchronization, refer to &lt;a href="https://docs.communityhealthtoolkit.org/hosting/analytics/"target="_blank" rel="noopener"&gt;CHT Sync&lt;/a&gt;.&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This tutorial will take you through setting up a couch2pg service.&lt;/p&gt;
&lt;p&gt;By the end of the tutorial you should be able to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Set up a couch2pg service&lt;/li&gt;
&lt;li&gt;Run the couch2pg service&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href="https://github.com/medic/cht-couch2pg"target="_blank" rel="noopener"&gt;CHT Couch2pg&lt;/a&gt; is a background process that moves data from Couchdb to Postgres through one way replication. It therefore, needs to have full read and write access to both the Postgres Database and Couchdb upstream. It is built in nodejs and can be set up as a background process using systemd. Review this &lt;a href="https://docs.communityhealthtoolkit.org/technical-overview/architecture/#overview"&gt;architecture diagram&lt;/a&gt; to get a conceptual understanding of how couch2pg works.&lt;/p&gt;
&lt;h2&gt;Brief Overview of key environmental variables&lt;span class="hx:absolute hx:-mt-20" id="brief-overview-of-key-environmental-variables"&gt;&lt;/span&gt;
&lt;a href="#brief-overview-of-key-environmental-variables" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;em&gt;COUCHDB_URL&lt;/em&gt; is the CouchDB instance URL with no trailing slash after &lt;code&gt;/medic&lt;/code&gt;, format: &lt;code&gt;https://[user]:[password]@localhost:[port]/medic&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;POSTGRESQL_URL&lt;/em&gt; is the PostgreSQL instance URL, format: &lt;code&gt;postgres://[user]:[password]@localhost:[port]/[database name]&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;COUCH2PG_SLEEP_MINS&lt;/em&gt; is the interval size in minutes Couch2pg will use to poll Couchdb.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;COUCH2PG_DOC_LIMIT&lt;/em&gt; is the number of documents Couch2pg will fetch in each query.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;COUCH2PG_RETRY_COUNT&lt;/em&gt; is the amount of times couch2pg should retry a failed connection before it fails.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;COUCH2PG_CHANGES_LIMIT&lt;/em&gt; is the number of changes to query since the last sync operation.&lt;/p&gt;
&lt;p&gt;To read more about environmental variables, see the &lt;a href="https://github.com/medic/cht-couch2pg#readme"target="_blank" rel="noopener"&gt;CHT Couch2pg readme&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Required Resources&lt;span class="hx:absolute hx:-mt-20" id="required-resources"&gt;&lt;/span&gt;
&lt;a href="#required-resources" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Before you begin, you need to have some useful software and tools that are required for things to work:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://nodejs.org/en/"target="_blank" rel="noopener"&gt;nodejs&lt;/a&gt; 8 up to 12.&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.npmjs.com/get-npm"target="_blank" rel="noopener"&gt;npm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.postgresql.org/"target="_blank" rel="noopener"&gt;PostgreSQL&lt;/a&gt; 9.4 or later&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Prerequisites&lt;span class="hx:absolute hx:-mt-20" id="prerequisites"&gt;&lt;/span&gt;
&lt;a href="#prerequisites" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;You should have a functioning &lt;a href="https://docs.communityhealthtoolkit.org/building/local-setup/"&gt;CHT instance installed locally&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;You should have a working database with a user that has full creation rights on the database. A database &lt;code&gt;POSTGRES_DB_NAME&lt;/code&gt; and &lt;code&gt;couch2pg&lt;/code&gt; user can be created and access granted using the following query:&lt;/p&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;pre&gt;&lt;code&gt;CREATE DATABASE POSTGRES_DB_NAME;
CREATE USER couch2pg WITH ENCRYPTED PASSWORD &amp;#39;mypassword&amp;#39;;
GRANT ALL PRIVILEGES ON DATABASE POSTGRES_DB_NAME TO couch2pg;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;All steps below require you to have a local clone of the repo.&lt;/p&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;git clone https://github.com/medic/cht-couch2pg.git&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;Setting up with environment variables&lt;span class="hx:absolute hx:-mt-20" id="setting-up-with-environment-variables"&gt;&lt;/span&gt;
&lt;a href="#setting-up-with-environment-variables" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Change directory into the repo&amp;rsquo;s directory where you cloned it: &lt;code&gt;cd /path/to/cht-couch2pg&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Install dependencies: &lt;code&gt;npm ci&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Export the four variables with the correct values:&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;POSTGRESQL_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;postgres://&lt;span class="o"&gt;[&lt;/span&gt;user&lt;span class="o"&gt;]&lt;/span&gt;:&lt;span class="o"&gt;[&lt;/span&gt;password&lt;span class="o"&gt;]&lt;/span&gt;@localhost:&lt;span class="o"&gt;[&lt;/span&gt;port&lt;span class="o"&gt;]&lt;/span&gt;/&lt;span class="o"&gt;[&lt;/span&gt;database name&lt;span class="o"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCHDB_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;https://&lt;span class="o"&gt;[&lt;/span&gt;user&lt;span class="o"&gt;]&lt;/span&gt;:&lt;span class="o"&gt;[&lt;/span&gt;password&lt;span class="o"&gt;]&lt;/span&gt;@localhost:&lt;span class="o"&gt;[&lt;/span&gt;port&lt;span class="o"&gt;]&lt;/span&gt;/medic
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCH2PG_DOC_LIMIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCH2PG_RETRY_COUNT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCH2PG_SLEEP_MINS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;120&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCH2PG_CHANGES_LIMIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1000&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ol start="4"&gt;
&lt;li&gt;Run: &lt;code&gt;node .&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;If you want to set and save all possible variables:&lt;/p&gt;
&lt;ol start="5"&gt;
&lt;li&gt;
&lt;p&gt;Copy &lt;code&gt;sample.env&lt;/code&gt; to &lt;code&gt;couch2pg.env&lt;/code&gt;: &lt;code&gt;cp sample.env couch2pg.env&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Edit &lt;code&gt;couch2pg.env&lt;/code&gt; to have all the variables you need.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-amber-200 hx:bg-amber-100 hx:text-amber-900 hx:dark:border-amber-200/30 hx:dark:bg-amber-900/30 hx:dark:text-amber-200"&gt;
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2"&gt;&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/&gt;&lt;/svg&gt;&lt;/div&gt;
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7"&gt;
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0"&gt;&lt;code&gt;POSTGRESQL_URL&lt;/code&gt; shouldn&amp;rsquo;t be edited as it is defined by the variables above it.&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ol start="7"&gt;
&lt;li&gt;Run: &lt;code&gt;. ./couch2pg.env &amp;amp;&amp;amp; node .&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-blue-200 hx:bg-blue-100 hx:text-blue-900 hx:dark:border-blue-200/30 hx:dark:bg-blue-900/30 hx:dark:text-blue-200"&gt;
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2"&gt;&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/&gt;&lt;/svg&gt;&lt;/div&gt;
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7"&gt;
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0"&gt;To run cht-couch2pg in interactive mode, use &lt;code&gt;node . -i&lt;/code&gt;. You will be prompted to answer questions to capture the same the environmental variables. For each question, you will be given suggestions for an answer.&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;Using docker compose&lt;span class="hx:absolute hx:-mt-20" id="using-docker-compose"&gt;&lt;/span&gt;
&lt;a href="#using-docker-compose" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The simplest way to run couch2pg is with &lt;code&gt;docker compose&lt;/code&gt; which only needs configuration of the CouchDB instance URL. The compose file will then create a PostgreSQL container, connect to the CouchDB server and proceed to download couchDB documents to the PostgreSQL container:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Change directory into the repo&amp;rsquo;s directory where you cloned it: &lt;code&gt;cd /path/to/cht-couch2pg&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Set the URL for CouchDB in the &lt;code&gt;COUCHDB_URL&lt;/code&gt; env variable. e.g.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;COUCHDB_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;https://medic:password@192-168-68-26.local-ip.medicmobile.org:8442/medic&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-blue-200 hx:bg-blue-100 hx:text-blue-900 hx:dark:border-blue-200/30 hx:dark:bg-blue-900/30 hx:dark:text-blue-200"&gt;
&lt;p class="hx:flex hx:items-center hx:font-medium"&gt;&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/&gt;&lt;/svg&gt;Note&lt;/p&gt;
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7"&gt;
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0"&gt;&lt;p&gt;The CouchDB URL needs to be reachable from the docker container (i.e. not localhost).&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ol start="3"&gt;
&lt;li&gt;
&lt;p&gt;Run: &lt;code&gt;docker compose up&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Connect to the PostgreSQL instance with login &lt;code&gt;cht_couch2pg&lt;/code&gt;, password &lt;code&gt;cht_couch2pg_password&lt;/code&gt; and database &lt;code&gt;cht&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-blue-200 hx:bg-blue-100 hx:text-blue-900 hx:dark:border-blue-200/30 hx:dark:bg-blue-900/30 hx:dark:text-blue-200"&gt;
&lt;p class="hx:flex hx:items-center hx:font-medium"&gt;&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/&gt;&lt;/svg&gt;Note&lt;/p&gt;
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7"&gt;
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0"&gt;&lt;p&gt;To set all possible variables or store the variables in configuration file, follow steps 5 and 6 above. To connect to the PostgreSQL instance, use the server from &lt;code&gt;POSTGRES_SERVER_NAME&lt;/code&gt;, use login from &lt;code&gt;COUCH2PG_USER&lt;/code&gt;, password from &lt;code&gt;COUCH2PG_USER_PASSWORD&lt;/code&gt; and the database from &lt;code&gt;POSTGRES_DB_NAME&lt;/code&gt;.&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;Known issues&lt;span class="hx:absolute hx:-mt-20" id="known-issues"&gt;&lt;/span&gt;
&lt;a href="#known-issues" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;Node version compatibility&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;Version 14 and 16 have been known to fail silently, and you can conveniently switch between node versions using &lt;a href="https://github.com/nvm-sh/nvm"target="_blank" rel="noopener"&gt;nvm&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="2"&gt;
&lt;li&gt;Postgres authentication&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;If the error &lt;code&gt;Error: Unknown authenticationOk message typeMessage { name: 'authenticationOk', length: 23 }&lt;/code&gt; is observed, it is because Postgres is setup to use a different password encryption algorithm compared to what Couch2pg uses. Couch2pg was made to work with &lt;code&gt;md5&lt;/code&gt; which is the default method in Postgres v10-13. However, on postgres v14 the default method is &lt;code&gt;scram-sha-256&lt;/code&gt; detailed in the &lt;a href="https://postgresqlco.nf/doc/en/param/password_encryption/14/"target="_blank" rel="noopener"&gt;notes&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The setting can be updated in the Postgres configuration file which is in &lt;code&gt;/etc/postgresql/14/main/postgres.conf&lt;/code&gt; in Ubuntu 20.04. The key &lt;code&gt;password_encryption&lt;/code&gt; should be set to md5. After updating the setting, restart the Postgres service.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;To confirm that the role used with couch2pg has an md5 encrypted password use the query &lt;code&gt;SELECT rolname, rolpassword FROM pg_authid&lt;/code&gt;. The role password should start with md5.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Fixing couch2pg Memory Errors</title><link>https://docs.communityhealthtoolkit.org/hosting/couch2pg/couch2pg-oom-errors/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/hosting/couch2pg/couch2pg-oom-errors/</guid><description>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-amber-200 hx:bg-amber-100 hx:text-amber-900 hx:dark:border-amber-200/30 hx:dark:bg-amber-900/30 hx:dark:text-amber-200"&gt;
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2"&gt;&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/&gt;&lt;/svg&gt;&lt;/div&gt;
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7"&gt;
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0"&gt;CHT couch2pg is deprecated. For data synchronization, refer to &lt;a href="https://docs.communityhealthtoolkit.org/hosting/analytics/"target="_blank" rel="noopener"&gt;CHT Sync&lt;/a&gt;.&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Some times when couch2pg is replicating documents to postgres, it encounters very large info docs that are larger than the memory allocation of the document sync array and causes out-of-memory errors.
To fix this, we need to delete this document so that couch2pg can proceed. Below are steps to follow to achieve this.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Reduce the size of the replicated docs to a value of say 4 in the couch2pg.conf file so that you can get within the range of the failing document.&lt;/li&gt;
&lt;li&gt;Clone the existing &lt;a href="https://github.com/medic/couch2pg"target="_blank" rel="noopener"&gt;couch2pg&lt;/a&gt; repo so that you can run couch2pg locally&lt;/li&gt;
&lt;li&gt;Edit the file &lt;code&gt;lib/importer.js&lt;/code&gt; in the couch2pg source code to be able to log the doc-id of the problem doc&lt;/li&gt;
&lt;li&gt;Edit just logs doc_ids to the console, around line 100 of importer.js &lt;code&gt;console.log(row.doc._id);&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Get the remote couch2pg environment variable settings and export them into your profile terminal&lt;/li&gt;
&lt;li&gt;Create an ssh reverse tunnel from the postgres server to your laptop&lt;/li&gt;
&lt;li&gt;Run couch2pg locally so that you can see the doc-ids on console till it fails&lt;/li&gt;
&lt;li&gt;From the ids printed on console try loading the docs in the couchdb web access(Futon or Fauxton), the problem doc is usually big and won&amp;rsquo;t load&lt;/li&gt;
&lt;li&gt;This will help you identify the problem doc&lt;/li&gt;
&lt;li&gt;Curl the document to your pc and back it up&lt;/li&gt;
&lt;li&gt;Back up the document for further analysis&lt;/li&gt;
&lt;li&gt;Delete the document using curl
&lt;code&gt;curl --head &amp;quot;&amp;lt;HOST&amp;gt;/&amp;lt;DB&amp;gt;/&amp;lt;DOC_ID&amp;gt;&amp;quot;&lt;/code&gt;
This returns something like&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"&gt;
&lt;div&gt;&lt;pre&gt;&lt;code&gt;HTTP/1.1 200 OK
Cache-Control: must-revalidate
Content-Length: 307
Content-Type: application/json
Date: Tue, 25 Jun 2019 11:58:29 GMT
ETag: &amp;#34;2-6beeb38da9b096bacfe2fa769e5171be&amp;#34;
Server: CouchDB/2.3.1 (Erlang OTP/21)
X-Couch-Request-ID: e4aa7a8696
X-CouchDB-Body-Time: 0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
&gt;
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The ETag is the rev. Delete document with curl: &lt;code&gt;curl -X DELETE &amp;quot;&amp;lt;HOST&amp;gt;/&amp;lt;DB&amp;gt;/&amp;lt;DOC_ID&amp;gt;?rev=&amp;lt;THE_REV&amp;gt;&amp;quot;&lt;/code&gt;&lt;/p&gt;</description></item></channel></rss>