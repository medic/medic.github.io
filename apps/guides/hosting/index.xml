<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Community Health Toolkit â€“ Hosting</title><link>https://docs.communityhealthtoolkit.org/apps/guides/hosting/</link><description>Recent content in Hosting on Community Health Toolkit</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/index.xml" rel="self" type="application/rss+xml"/><item><title>Apps: Requirements</title><link>https://docs.communityhealthtoolkit.org/apps/guides/hosting/requirements/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/apps/guides/hosting/requirements/</guid><description>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">Note&lt;/h4>
For production CHT deployments, Linux is recommended, with &lt;a href="https://ubuntu.com/server">Ubuntu&lt;/a> the most commonly used. For CHT development, Linux or macOS may be used. Windows can be used for either, but without recommendation.
&lt;/div>
&lt;p>Hosting a CHT instance in a cloud provider like AWS or on bare-metal requires you have sufficient hardware specifications, Docker and Docker Compose installed and other infrastructure requirements met.&lt;/p>
&lt;h2 id="hardware-requirements">Hardware Requirements&lt;/h2>
&lt;ul>
&lt;li>4 GiB RAM&lt;/li>
&lt;li>2 CPU/vCPU&lt;/li>
&lt;li>8 GB Hard Disk (SSD prefered)&lt;/li>
&lt;li>SSL certificates ( To be able to use the CHT app on mobile)&lt;/li>
&lt;li>Root Access&lt;/li>
&lt;/ul>
&lt;p>Depending on the scale of your operation these may need to be adjusted. Be sure to monitor disk usage so that the 8 GB can be increased as needed.&lt;/p>
&lt;h2 id="docker">Docker&lt;/h2>
&lt;p>Install both &lt;code>docker&lt;/code> and &lt;code>docker-compose&lt;/code> to run the two &lt;code>medic-os&lt;/code> and &lt;code>haproxy&lt;/code> containers.&lt;/p>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">Note&lt;/h4>
Skip this step if you&amp;rsquo;re following the &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/ec2-setup-guide/#create-and-configure-ec2-instance">EC2 guide&lt;/a> as &lt;code>docker&lt;/code> and &lt;code>docker-compose&lt;/code> are automatically installed when following the setup scripts.
&lt;/div>
&lt;h3 id="linux">Linux&lt;/h3>
&lt;p>Depending on which distro you run, install the Docker packages from &lt;a href="https://docs.docker.com/engine/install/#server">Docker&amp;rsquo;s Linux options&lt;/a>. Historically, Medic runs Ubuntu: see &lt;a href="https://docs.docker.com/engine/install/ubuntu/">Docker CE&lt;/a> and &lt;a href="https://docs.docker.com/compose/install/">Docker-compose&lt;/a> install pages.&lt;/p>
&lt;h3 id="windows">Windows&lt;/h3>
&lt;p>Docker Desktop for Windows needs either Hyper-V support or Windows Subsystem for Linux 2 (WSL 2). &lt;a href="https://docs.docker.com/docker-for-windows/install/">Docker&amp;rsquo;s Windows Docker Desktop install page&lt;/a> covers both scenarios.&lt;/p>
&lt;h3 id="macos">macOS:&lt;/h3>
&lt;p>See &lt;a href="https://docs.docker.com/docker-for-mac/install/">Docker&amp;rsquo;s macOS Docker Desktop install page&lt;/a>.&lt;/p>
&lt;h3 id="verify-install">Verify install&lt;/h3>
&lt;p>Test that &lt;code>docker&lt;/code> and &lt;code>docker-compose&lt;/code> installed correctly by showing their versions with &lt;code>sudo docker-compose --version&lt;/code> and &lt;code>sudo docker --version&lt;/code>. Note, your version may be different:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo docker-compose --version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker-compose version 1.27.1, build 509cfb99
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo docker --version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Docker version 19.03.12, build 48a66213fe
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Finally, confirm you can run the &amp;ldquo;hello world&amp;rdquo; docker container: &lt;code>sudo docker run hello-world&lt;/code>&lt;/p>
&lt;h2 id="considerations">Considerations&lt;/h2>
&lt;p>There are serious implications to consider when deploying a CHT instance beyond the above requirements. Be sure to account for:&lt;/p>
&lt;ul>
&lt;li>Alerting - How will alerts be sent in the case of downtime or degraded service?&lt;/li>
&lt;li>Power failures and unplanned restarts - Will the server cleanly restart such that the CHT resumes service correctly?&lt;/li>
&lt;li>Backups - What happens to the CHT data if there&amp;rsquo;s a hard drive failure?&lt;/li>
&lt;li>Disaster Recovery - What happens if there is a flood at the facility and on-site active and backup data are destroyed?&lt;/li>
&lt;li>Scale - What happens when the hardware deployed needs to be upgraded to increase capacity?&lt;/li>
&lt;li>Updates - By definition TLS certificates expire and software needs to be updated - how will the deployment get these updates on a regular basis?&lt;/li>
&lt;li>Security - While the TLS certificate will protect data on the LAN, is the server hard drive encrypted in the event of property theft?&lt;/li>
&lt;li>Privacy - The CHT inherently carries sensitive patient medical information in the database. Are there sufficient measures in place to protect this sensitive data?&lt;/li>
&lt;/ul></description></item><item><title>Apps: AWS Hosting</title><link>https://docs.communityhealthtoolkit.org/apps/guides/hosting/ec2-setup-guide/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/apps/guides/hosting/ec2-setup-guide/</guid><description>
&lt;p>Most production CHT instances are deployed on AWS EC2. Leveraging Elastic Compute Cloud (EC2) and Elastic Block Store (EBS), CHT instances can easily be scaled up with larger EC2 instances and have easy increased disk space, backup and restores with EBS.&lt;/p>
&lt;p>This guide will walk you through the process of creating an EC2 instance, mounting an EBS volume and provisioning Docker containers.&lt;/p>
&lt;h2 id="create-and-configure-ec2-instance">Create and Configure EC2 Instance&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>Create EC2 (use security best practices)&lt;/p>
&lt;p>Review the &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/requirements/#hardware-requirements">CHT hardware requirements&lt;/a> and start with an appropriately sized instance. After creating the instance and downloading the &lt;code>.pem&lt;/code> file, change permissions to &lt;code>0600&lt;/code> for it:&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo chmod 0600 ~/Downloads/name_of_file.pem
&lt;/code>&lt;/pre>&lt;p>Create an &lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html">Elastic IP (EIP) and associate the EIP to your EC2 instance&lt;/a>.&lt;/p>
&lt;p>You should now be able to SSH into the EC2 instance using the EIP and the &lt;code>.pem&lt;/code> file.&lt;/p>
&lt;p>&lt;code>Goal&lt;/code>: SSH into instance&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Create or Restore EBS Volume&lt;/p>
&lt;ul>
&lt;li>Create or &lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ebs-restoring-volume.html">Restore&lt;/a> your EBS Volume, tagging appropriately, so it can be found later.&lt;/li>
&lt;li>Attach volume to EC2 instance&lt;/li>
&lt;li>&lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html">Increase disk size&lt;/a> (Optional)&lt;/li>
&lt;li>If you are using a newly created EBS Volume, you will have to format the disk appropriately:
&lt;ol>
&lt;li>SSH into instance&lt;/li>
&lt;li>Follow the instructions here: &lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-using-volumes.html">Using EBS Volumes&lt;/a>&lt;/li>
&lt;li>Use &lt;code>sudo mkfs -t ext4 &amp;lt;location&amp;gt;&lt;/code> in step 4&lt;/li>
&lt;li>Mount disk to &lt;code>/srv&lt;/code>&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;p>&lt;code>Goal&lt;/code>: Mount EBS volume to &lt;code>/srv&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Provision Docker server&lt;/p>
&lt;p>Follow README &amp;amp; Run scripts in &lt;a href="https://github.com/medic/cht-infrastructure/tree/master/self-hosting/prepare-system">cht-infrastructure repository&lt;/a>.&lt;/p>
&lt;p>&lt;code>Goal&lt;/code>: CHT Application bootstraps and comes online&lt;/p>
&lt;/li>
&lt;li>
&lt;p>DNS configuration&lt;/p>
&lt;ul>
&lt;li>Point DNS &lt;code>A&lt;/code> record to EIP given to Docker server in the prior step.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Review SSL certificates&lt;/p>
&lt;ul>
&lt;li>Location of certs is &lt;code>/srv/settings/medic-core/nginx/private/&lt;/code>&lt;/li>
&lt;li>Name the key file is &lt;code>default.key&lt;/code> and the certificate file is &lt;code>default.crt&lt;/code>&lt;/li>
&lt;li>See &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/ssl-cert-install/">SSL Certficates&lt;/a> to install new certificates&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Configure couch2pg
See the &lt;a href="https://github.com/medic/cht-couch2pg/blob/main/README.md">couch2pg basic configuration&lt;/a> in the &lt;code>cht-couch2pg&lt;/code> repository.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Setup postgres to work with couch2pg&lt;/p>
&lt;ul>
&lt;li>Creating the database, setting up permissions, exploring the tables and what they store&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Debugging couch2pg/postgres&lt;/p>
&lt;ul>
&lt;li>Understanding the log and what the entries mean&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="troubleshooting">Troubleshooting&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>Restarting processes&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.communityhealthtoolkit.org/core/guides/docker-setup/#helpful-docker-commands">How to access container, retrieve logs, restart services&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/medic/medic-os#user-content-service-management-scripts">MedicOS service management scripts&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Investigating logs&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.communityhealthtoolkit.org/core/guides/docker-setup/#helpful-docker-commands">Helpful docker commands&lt;/a> (includes getting shell on containers)&lt;/li>
&lt;li>Inside container, all appropriate logs can be found in: &lt;code>/srv/storage/&amp;lt;service_name&amp;gt;/logs/*.log&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Upgrading the container&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Backup all data (EBS)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Log into container and stop all services&lt;/p>
&lt;/li>
&lt;li>
&lt;p>To prepare for the upgrade, delete all other files in &lt;code>/srv&lt;/code> EXCEPT for &lt;code>/srv/storage/medic-core/&lt;/code>&lt;/p>
&lt;p>The &lt;code>medic-core&lt;/code> directory is where the CHT stores user data. Of key importance is &lt;code>./couchdb/local.in&lt;/code> and &lt;code>./medic-core/couchdb/local.d/&lt;/code> where custom CouchDB configuration is stored.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://docs.communityhealthtoolkit.org/core/guides/docker-setup/#use-docker-compose">Change the image tag to the newest image release version&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://docs.communityhealthtoolkit.org/core/guides/docker-setup/#use-docker-compose">Change image tag in docker-compose file&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Launch new containers with appropriate &lt;code>COUCHDB_ADMIN_PASSWORD&lt;/code> &amp;amp; &lt;code>HA_PASSWORD&lt;/code> environment variables&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Upgrading the webapp&lt;/p>
&lt;ul>
&lt;li>Use Admin GUI page&lt;/li>
&lt;li>&lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/self-hosting/#links-to-medic-documentation-for-horticulturalist-for-upgrades">CLI via horticulturalist&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>RDS help&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Welcome.html">Amazon user guide&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="backups">Backups&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>Configure backups&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/snapshot-lifecycle.html">EBS Snapshot Lifecycle Manager&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Restoring from backup&lt;/p>
&lt;ul>
&lt;li>Create volume from snapshot&lt;/li>
&lt;li>Tag appropriately for backups&lt;/li>
&lt;li>Mount volume to docker server&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="process-supervision">Process supervision&lt;/h2>
&lt;ul>
&lt;li>&lt;code>supvisorctl&lt;/code>&lt;/li>
&lt;li>&lt;code>/boot/supervisor-inspect&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="increasing-disk-size">Increasing disk size&lt;/h2>
&lt;p>Monitor disk usage so alerts are sent before all disk spaces is used up. If free disk space falls below 40%, increase the disk space as follows:&lt;/p>
&lt;ul>
&lt;li>Stop medic: &lt;code>sudo supervisorctl stop medic&lt;/code>&lt;/li>
&lt;li>Go to EBS in AWS and take a snapshot of the volume.&lt;/li>
&lt;li>Modify the volume size (Increase it by 2x preferably). Wait until the modification succeeds.&lt;/li>
&lt;li>&lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html">Make the instance recognize the additional space&lt;/a>&lt;/li>
&lt;li>Turn medic back on: &lt;code>sudo supervisorctl start medic&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="monitoring--backup">Monitoring &amp;amp; Backup&lt;/h2>
&lt;ul>
&lt;li>AWS CloudWatch and monitoring tab. Enable detailed monitoring (This costs more money)&lt;/li>
&lt;li>Set up &lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/snapshot-lifecycle.html#snapshot-lifecycle-console">Lifecycle Management for EBS snapshots&lt;/a>&lt;/li>
&lt;li>Steps to mounting a backup snapshot to the instance and restarting the application&lt;/li>
&lt;li>Please see the second-half of &amp;ldquo;Increasing disk size&amp;rdquo; reference above&lt;/li>
&lt;li>Setup a TLS cert &amp;amp; DNS registration&lt;/li>
&lt;/ul></description></item><item><title>Apps: Self Hosting</title><link>https://docs.communityhealthtoolkit.org/apps/guides/hosting/self-hosting/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/apps/guides/hosting/self-hosting/</guid><description>
&lt;p>Whether run on bare-metal or in a cloud provider, the Community Health Toolkit (CHT) core framework has been packaged into a docker container to make it portable and easy to install. It is available from &lt;a href="https://hub.docker.com/r/medicmobile/medic-os">dockerhub&lt;/a>. To learn more how to work with docker you could follow the tutorial &lt;a href="https://docker-curriculum.com/#getting-started">here&lt;/a> and the cheat sheet &lt;a href="https://www.docker.com/sites/default/files/d8/2019-09/docker-cheat-sheet.pdf">here&lt;/a>.&lt;/p>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">Note&lt;/h4>
Before continuing, ensure all &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/requirements/">requirements&lt;/a> are met.
&lt;/div>
&lt;h2 id="installing-with-a-compose-file">Installing with a compose file&lt;/h2>
&lt;p>The CHT containers are installed using &lt;a href="https://docs.docker.com/compose/reference/overview/">docker compose&lt;/a> so that you can run multiple containers as a single service.&lt;/p>
&lt;p>Start by choosing the location where you would like to save your compose configuration file. Then create the &lt;code>docker-compose.yml&lt;/code> file by &lt;code>cd&lt;/code>ing into the correct directory and running:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>curl -s -o docker-compose.yml https://raw.githubusercontent.com/medic/cht-core/master/docker-compose.yml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The install requires an admin password that it will configure in the database. You need to provide this externally as an environment variable. Before you run the compose file, you need to export this variable as shown below.&lt;/p>
&lt;p>&lt;code>export DOCKER_COUCHDB_ADMIN_PASSWORD=myAwesomeCHTAdminPassword&lt;/code>&lt;/p>
&lt;p>You can then run &lt;code>docker-compose&lt;/code> in the folder where you put your compose &lt;code>docker-compose.yml&lt;/code> file. To start, run it interactively to see all the logs on screen and be able to stop the containers with &lt;code>ctrl&lt;/code> + &lt;code>c&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>sudo docker-compose up
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If there are no errors, stop the containers with &lt;code>ctrl&lt;/code> + &lt;code>c&lt;/code> and then run it detached with &lt;code>-d&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>sudo docker-compose up -d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Note In certain shells, &lt;code>docker-compose&lt;/code> may not interpolate the admin password that was exported in &lt;code>DOCKER_COUCHDB_ADMIN_PASSWORD&lt;/code>. Check if this is the case by searching the logs in the medic-os dockers instance. If the &lt;code>docker logs medic-os&lt;/code> command below returns a user and password, then the export above failed, and you should use this user and password to complete the installation:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>docker logs medic-os &lt;span style="color:#000;font-weight:bold">|&lt;/span>grep &lt;span style="color:#4e9a06">&amp;#39;New CouchDB Admin&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Info: New CouchDB Administrative User: medic
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Info: New CouchDB Administrative Password: password
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Monitor the logs until you get the &lt;code>Setting up software (100% complete)&lt;/code> message. At this stage all containers are fully set up.&lt;/p>
&lt;p>Once containers are setup, please run the following command from your host terminal:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>sudo docker &lt;span style="color:#204a87">exec&lt;/span> -it medic-os /bin/bash -c &lt;span style="color:#4e9a06">&amp;#34;sed -i &amp;#39;s/--install=3.9.0/--complete-install/g&amp;#39; /srv/scripts/horticulturalist/postrun/horticulturalist&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo docker &lt;span style="color:#204a87">exec&lt;/span> -it medic-os /bin/bash -c &lt;span style="color:#4e9a06">&amp;#34;/boot/svc-disable medic-core openssh &amp;amp;&amp;amp; /boot/svc-disable medic-rdbms &amp;amp;&amp;amp; /boot/svc-disable medic-couch2pg&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The first command fixes a postrun script for horticulturalist to prevent unique scenarios of re-install. The second command removes extra services that you will not need.&lt;/p>
&lt;h3 id="visit-your-project">Visit your project&lt;/h3>
&lt;p>If you&amp;rsquo;re running this on your local machine, then open a browser to &lt;a href="https://localhost">https://localhost&lt;/a>. Otherwise open a browser to the public IP of the host if it&amp;rsquo;s running remotely.&lt;/p>
&lt;p>You will have to click to through the SSL Security warning. Click &amp;ldquo;Advanced&amp;rdquo; -&amp;gt; &amp;ldquo;Continue to site&amp;rdquo;.&lt;/p>
&lt;h3 id="clean-up-and-re-install">Clean up and re-install&lt;/h3>
&lt;p>If some instructions were missed and there&amp;rsquo;s a broken CHT deployment, use the commands below to start afresh:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Stop containers: &lt;code>docker stop medic-os &amp;amp;&amp;amp; docker stop haproxy&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Remove containers: &lt;code>docker rm medic-os &amp;amp;&amp;amp; docker rm haproxy&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Clean data volume:&lt;code>docker volume rm medic-data&lt;/code>&lt;/p>
&lt;p>Note: Running &lt;code>docker-compose -f docker-compose.yml down -v&lt;/code> would do all the above 3 steps&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Prune system: &lt;code>docker system prune&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>After following the above commands, you can re-run docker-compose up and create a clean install: &lt;code>docker-compose -f docker-compose.yml up -d&lt;/code>&lt;/p>
&lt;h3 id="port-conflicts">Port Conflicts&lt;/h3>
&lt;p>In case you are already running services on HTTP(80) and HTTPS(443),you will have to either remap ports to the medic-os container or stop the services using those ports.&lt;/p>
&lt;p>To find out which service is using a conflicting port: On Linux:&lt;/p>
&lt;p>&lt;code>sudo netstat -plnt | grep ':&amp;lt;port&amp;gt;'&lt;/code>&lt;/p>
&lt;p>On Mac (10.10 and above):&lt;/p>
&lt;p>&lt;code>sudo lsof -iTCP -sTCP:LISTEN -n -P | grep ':&amp;lt;port&amp;gt;'&lt;/code>&lt;/p>
&lt;p>You can either kill the service which is occupying HTTP/HTTPS ports, or run the container with forwarded ports that are free. In your compose file, change the ports under medic-os:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">services&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">medic-os&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">container_name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">medic-os&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">image&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">medicmobile/medic-os:cht-3.7.0-rc.1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">volumes&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">medic-data:/srv&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ports&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">8080&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">80&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">444&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">443&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Turn off and remove all existing containers that were started:&lt;/p>
&lt;p>&lt;code>sudo docker-compose -f /path/to/docker-compose.yml down&lt;/code>&lt;/p>
&lt;p>Bring Up the containers in detached mode with the new forwarded ports.&lt;/p>
&lt;p>&lt;code>sudo docker-compose -f /path/to/docker-compose.yml up -d&lt;/code>&lt;/p>
&lt;p>Note: You can substitute 8080, 444 with whichever ports are free on your host. You would now visit https://localhost:444 to visit your project.&lt;/p>
&lt;h2 id="data-storage--persistence">Data storage &amp;amp; persistence&lt;/h2>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">Note&lt;/h4>
Containers that are already set up will lose all data when following the steps below to remap the &lt;code>/srv&lt;/code> directory.
&lt;/div>
&lt;p>Docker containers are &lt;a href="https://www.redhat.com/en/topics/cloud-native-apps/stateful-vs-stateless">stateless&lt;/a> by design. In order to persist your data when a container restarts you need to specify the volumes that the container can use to store data. The CHT app stores all its data in the &lt;code>/srv&lt;/code> folder. This is the folder that you need to map to your volume before you spin up your containers.&lt;/p>
&lt;p>Ideally you should map this folder to a volume that is backed up regularly by your cloud hosting provider.&lt;/p>
&lt;p>The example below shows how to map this folder in Ubuntu:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Create the &lt;code>/srv&lt;/code> folder: &lt;code>sudo mkdir /srv&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Mount your volume to this folder: &lt;code>sudo mount /dev/xvdg /srv&lt;/code> . The attached volume number varies. Find your volume by running &lt;code>lsblk&lt;/code>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Update your compose file so that the containers store data to this folder&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">services&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">medic-os&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">container_name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">medic-os&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">image&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">medicmobile/medic-os:cht-3.9.0-rc.2&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">volumes&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">/srv:/srv&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>----&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">haproxy&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">container_name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">haproxy&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">image&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">medicmobile/haproxy:rc-1.17&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">volumes&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">/srv:/srv &lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>Alternatively, can create the &lt;code>/srv&lt;/code> folder on any drive with enough space that is regularly backed up. Then map the path to the folder in the compose file like this.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">volumes&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">/path/to/srv:/srv&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Be sure to check the available storage space regularly and expand your volume when needed&lt;/p>
&lt;h2 id="backup">Backup&lt;/h2>
&lt;p>Regular backups should be made of the &lt;code>/srv&lt;/code> directory to have holistic and easy to restore copies of all important data and the current CHT version installed. To backup just the data and not the CHT, make copies of &lt;code>/srv/storage/medic-core/&lt;/code>. This directory includes 4 key sub-directies:&lt;/p>
&lt;ul>
&lt;li>./couchdb&lt;/li>
&lt;li>./openssh&lt;/li>
&lt;li>./nginx&lt;/li>
&lt;li>./passwd&lt;/li>
&lt;/ul>
&lt;p>To make backups of just CouchDB data outside of the CHT docker infrastructure, please see &lt;a href="https://docs.couchdb.org/en/2.3.1/maintenance/backups.html">CouchDB&amp;rsquo;s Backup docs for 2.3.1&lt;/a>. Please note:&lt;/p>
&lt;ul>
&lt;li>CouchDB data files are in &lt;code>/srv/storage/medic-core/couchdb/data&lt;/code> in the &lt;code>medic-os&lt;/code> container.&lt;/li>
&lt;li>Backing up via replication is discouraged as restored DBs can cause offline users to restart replication from zero. Use file backups instead.&lt;/li>
&lt;/ul></description></item><item><title>Apps: App Developer Hosting</title><link>https://docs.communityhealthtoolkit.org/apps/guides/hosting/app-developer/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/apps/guides/hosting/app-developer/</guid><description>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">Note&lt;/h4>
&lt;p>This guide assumes you are a CHT app developer wanting to either run concurrent instances of the CHT, or easily be able to switch between different instances without loosing any data while doing so. To do development on the CHT core itself, see the &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/core-developer/">development guide&lt;/a>.&lt;/p>
&lt;p>To deploy the CHT in production, see either &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/self-hosting/">AWS hosting&lt;/a> or &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/ec2-setup-guide/">Self hosting&lt;/a>&lt;/p>
&lt;/div>
&lt;h2 id="getting-started">Getting started&lt;/h2>
&lt;p>Be sure to meet the &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/requirements/">CHT hosting requirements&lt;/a> first. As well, if any other &lt;code>medic-os&lt;/code> instances using &lt;a href="https://github.com/medic/cht-core/blob/master/docker-compose.yml">the main &lt;code>docker-compose.yml&lt;/code> file&lt;/a> are running locally, stop them otherwise port, storage volume and container name conflicts may occur.&lt;/p>
&lt;p>After meeting these requirements, download the developer YAML file in the directory you want to store them:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>curl -o docker-compose-developer.yml https://raw.githubusercontent.com/medic/cht-core/master/docker-compose-developer.yml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>To start the first developer CHT instance, run &lt;code>docker-compose&lt;/code> and specify the file that was just download:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>docker-compose -f docker-compose-developer.yml up
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This may take some minutes to fully start depending on the speed of the Internet connection and speed of the bare-metal host. This is because docker needs to download all the storage layers for all the containers and the CHT needs to run the first run set up. After downloads and setup has completed, the CHT should be accessible on &lt;a href="https://localhost">https://localhost&lt;/a>.&lt;/p>
&lt;p>When connecting to a new dev CHT instance for the first time, an error will be shown, &amp;ldquo;Your connection is not private&amp;rdquo; (see &lt;a href="https://docs.communityhealthtoolkit.org/apps/tutorials/local-setup/privacy.error.png">screenshot&lt;/a>). To get past this, click &amp;ldquo;Advanced&amp;rdquo; and then click &amp;ldquo;Proceed to localhost&amp;rdquo;.&lt;/p>
&lt;h2 id="running-the-nth-cht-instance">Running the Nth CHT instance&lt;/h2>
&lt;p>After running the first instance of the CHT, it&amp;rsquo;s easy to run as many more as are needed. This is achieved by specifying different:&lt;/p>
&lt;ul>
&lt;li>port for &lt;code>HTTP&lt;/code> redirects (&lt;code>CHT_HTTP&lt;/code>)&lt;/li>
&lt;li>port for &lt;code>HTTPS&lt;/code> traffic (&lt;code>CHT_HTTPS&lt;/code>)&lt;/li>
&lt;li>project to for the docker compose call (&lt;code>-p PROJECT&lt;/code>)&lt;/li>
&lt;/ul>
&lt;p>Assuming you want to start a new project called &lt;code>the_second&lt;/code> and start the instance on &lt;code>HTTP&lt;/code> port &lt;code>8081&lt;/code> and &lt;code>HTTPS&lt;/code> port &lt;code>8443&lt;/code>, this would be the command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">CHT_HTTP&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">8081&lt;/span> &lt;span style="color:#000">CHT_HTTPS&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">8443&lt;/span> docker-compose -p the_second -f docker-compose-developer.yml up
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The second instance is now accessible at &lt;a href="https://localhost:8443">https://localhost:8443&lt;/a>.&lt;/p>
&lt;h2 id="the-env-file">The &lt;code>.env&lt;/code> file&lt;/h2>
&lt;p>Often times it&amp;rsquo;s convenient to use revision control, like GitHub, to store and publish changes in a CHT app. A nice compliment to this is to store the specifics on how to run the &lt;code>docker-compose&lt;/code> command for each app. By using a shared &lt;code>docker-compose&lt;/code> configuration for all developers on the same app, it avoids any port collisions and enables all developers to have a unified configuration.&lt;/p>
&lt;p>Using the above &lt;code>the_second&lt;/code> sample project, we can create another directory to host this project&amp;rsquo;s configuration:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>mkdir ../the_second
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Create a file &lt;code>../the_second/.env-docker-compose&lt;/code> with this contents:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">COMPOSE_PROJECT_NAME&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>the_second
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">CHT_HTTP&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">8081&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">CHT_HTTPS&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">8443&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now it&amp;rsquo;s easy to boot this environment by specifying which &lt;code>.env&lt;/code> file to use:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>docker-compose --env-file ../the_second/.env-docker-compose -f docker-compose-developer.yml up
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="switching--concurrent-projects">Switching &amp;amp; concurrent projects&lt;/h2>
&lt;p>The easiest way to switch between projects is to stop the first set of containers and start the second set. Cancel the first project running in the foreground with &lt;code>ctrl + c&lt;/code>. Then start the second project using either the &lt;code>.env&lt;/code> file or use the explicit command with ports and project name as shown above.&lt;/p>
&lt;p>To run projects concurrently, instead of cancelling the first one, open a second terminal and start the second project.&lt;/p>
&lt;p>To read more about how &lt;code>docker-compose&lt;/code> works, be sure to read the &lt;a href="https://docs.communityhealthtoolkit.org/core/guides/docker-setup/#helpful-docker-commands">helpful docker-compose commands&lt;/a> page.&lt;/p>
&lt;h2 id="cht-docker-helper">CHT Docker Helper&lt;/h2>
&lt;p>The &lt;code>cht-docker-compose.sh&lt;/code> scripts builds on the &lt;code>docker-compose-developer.yml&lt;/code> and &lt;code>.env&lt;/code> files used above by helping start CHT instances with a simple text based GUI:&lt;/p>
&lt;p>&lt;img src="cht-docker-helper.png" alt="The cht-docker-compose.sh script showing the URL and version of the CHT instance as well as number of containers launched, global container count, medic images downloaded count and OS load average. Finally a &amp;amp;ldquo;Successfully started my_first_project&amp;amp;rdquo; message is shown and denotes the login is &amp;amp;ldquo;medic&amp;amp;rdquo; and the password is &amp;amp;ldquo;password&amp;amp;rdquo;.">&lt;/p>
&lt;h3 id="prerequisites">Prerequisites&lt;/h3>
&lt;h4 id="os">OS&lt;/h4>
&lt;p>This script has been heavily tested on Ubuntu and should work very well there. It has been lightly tested on WSL2 on Windows 10 and macOS (x86, not Apple silicon like M1 etc.) - both should likely work as well.&lt;/p>
&lt;h4 id="software">Software&lt;/h4>
&lt;p>The script will check and require these commands. All but &lt;code>docker&lt;/code> and &lt;code>docker-compose&lt;/code> should be installed by default on Ubuntu:&lt;/p>
&lt;ul>
&lt;li>awk&lt;/li>
&lt;li>curl&lt;/li>
&lt;li>cut&lt;/li>
&lt;li>dirname&lt;/li>
&lt;li>docker (At least version 20.x)&lt;/li>
&lt;li>docker-compose (At least version 1.27)&lt;/li>
&lt;li>file&lt;/li>
&lt;li>grep&lt;/li>
&lt;li>head&lt;/li>
&lt;li>nc&lt;/li>
&lt;li>tail&lt;/li>
&lt;li>tr&lt;/li>
&lt;li>wc&lt;/li>
&lt;/ul>
&lt;p>Optionally you can install &lt;code>jq&lt;/code> so that the script can parse JSON and tell you which version of the CHT is running.&lt;/p>
&lt;h4 id="docker-compose-file-and-helper-scripts">Docker compose file and helper scripts&lt;/h4>
&lt;p>An up-to-date clone of &lt;a href="https://github.com/medic/cht-core/">cht-core&lt;/a> has everything you need including:&lt;/p>
&lt;ul>
&lt;li>&lt;code>docker-compose-developer.yml&lt;/code>&lt;/li>
&lt;li>&lt;code>cht-docker-compose.sh&lt;/code>&lt;/li>
&lt;li>&lt;code>docker-status.sh&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="using">Using&lt;/h3>
&lt;h4 id="syntax">Syntax&lt;/h4>
&lt;p>The helper script is run by calling &lt;code>./cht-docker-compose.sh&lt;/code>. It accepts one required and one optional arguments:&lt;/p>
&lt;ul>
&lt;li>&lt;code>-e | --env-file&lt;/code> - path to the environment file. Required&lt;/li>
&lt;li>&lt;code>-d | --docker_action&lt;/code> - docker action to run: &lt;code>up&lt;/code>, &lt;code>down&lt;/code> or &lt;code>destory&lt;/code>. Optional, defaults to &lt;code>up&lt;/code>&lt;/li>
&lt;/ul>
&lt;h4 id="nomenclature">Nomenclature&lt;/h4>
&lt;p>Docker containers, networks and volumes are always named after the project you&amp;rsquo;re using. So if your project is called &lt;code>my_first_project&lt;/code>, you will see:&lt;/p>
&lt;ul>
&lt;li>Two containers: &lt;code>my_first_project_medic-os_1&lt;/code> and &lt;code>my_first_project_haproxy_1&lt;/code>&lt;/li>
&lt;li>One storage volume: &lt;code>my_first_project_medic-data&lt;/code>&lt;/li>
&lt;li>One network: &lt;code>my_first_project_medic-net&lt;/code>&lt;/li>
&lt;/ul>
&lt;h4 id="first-run">First Run&lt;/h4>
&lt;p>These steps assume:&lt;/p>
&lt;ul>
&lt;li>the first project is &lt;code>my_first_project&lt;/code>&lt;/li>
&lt;li>one &lt;code>.env_docker&lt;/code> environment file per project&lt;/li>
&lt;li>&lt;code>my_first_project&lt;/code> and &lt;code>cht-core&lt;/code> directories are next to each other in the same parent directory&lt;/li>
&lt;li>you have Internet connectivity (&lt;em>See &lt;a href="#booting-with-no-connectivity">booting with no connectivity&lt;/a>&lt;/em>)&lt;/li>
&lt;/ul>
&lt;p>Follow these steps to create your first developer instance. You can create as many as you&amp;rsquo;d like:&lt;/p>
&lt;ol>
&lt;li>create &lt;code>./my_first_project/.env_docker&lt;/code> with the contents:
&lt;pre tabindex="0">&lt;code>COMPOSE_PROJECT_NAME=my_first_project
CHT_HTTP=8080
CHT_HTTPS=8443
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>Change into the &lt;code>docker-help&lt;/code> directory: &lt;code>cd ./cht-core/scripts/docker-helper/&lt;/code>&lt;/li>
&lt;li>Run the helper script and specify your &lt;code>.env_docker&lt;/code> file:
&lt;pre tabindex="0">&lt;code>./cht-docker-compose.sh -e ../../../my_first_project/.env_docker
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>Your CHT instance will be started when you see the text:
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>Successfully started project my_first_project
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h4 id="second-run">Second Run&lt;/h4>
&lt;p>When you&amp;rsquo;re done with an instance, be sure to shut it down:&lt;/p>
&lt;pre tabindex="0">&lt;code>./cht-docker-compose.sh -e ../../../my_first_project/.env_docker -d down
&lt;/code>&lt;/pre>&lt;p>All information will be saved, and it should be quick to start for the Nth time.&lt;/p>
&lt;p>To start an existing instance again, just run the command from the &amp;ldquo;First Run&amp;rdquo; section:&lt;/p>
&lt;pre tabindex="0">&lt;code>./cht-docker-compose.sh -e ../../../my_first_project/.env_docker
&lt;/code>&lt;/pre>&lt;p>This command is safe to run as many times as you&amp;rsquo;d like if you forget the state of your project&amp;rsquo;s Docker containers.&lt;/p>
&lt;h4 id="last-run">Last Run&lt;/h4>
&lt;p>When you&amp;rsquo;re done with a project and want to completely destroy it, run &lt;code>destroy&lt;/code>:&lt;/p>
&lt;pre tabindex="0">&lt;code>./cht-docker-compose.sh -e ../../../my_first_project/.env_docker -d destroy
&lt;/code>&lt;/pre>&lt;p>&lt;em>&lt;strong>NOTE&lt;/strong>&lt;/em> - Be sure you want to run &lt;code>destroy&lt;/code>. The script will &lt;em>not&lt;/em> prompt &amp;ldquo;are you sure?&amp;rdquo; and it will just delete all your project&amp;rsquo;s data.&lt;/p>
&lt;h3 id="troubleshooting">Troubleshooting&lt;/h3>
&lt;p>The main issue you&amp;rsquo;re likely to run into is that the CHT doesn&amp;rsquo;t correctly start up, the very reason this script was created. If the script either hangs on one step, or fails to start and quits after 5 tries, try these steps:&lt;/p>
&lt;ol>
&lt;li>Ensure your Internet is working.&lt;/li>
&lt;li>Destroy everything by using the &lt;code>-d destroy&lt;/code> &lt;a href="#syntax">option&lt;/a>. While this will delete any data, if you can&amp;rsquo;t start the CHT instance, you won&amp;rsquo;t be loosing any data you care about ;). This will delete the containers and volumes. Then run &lt;code>-d up&lt;/code> and try again.&lt;/li>
&lt;li>Quit apps that may be causing a high load on your computer. Possibly consider rebooting and running nothing else. In one instance this helped!&lt;/li>
&lt;/ol>
&lt;p>If you still get stuck review the items below as possible issues you may find workarounds to. If none of these work, see the debug file which is always output in the same directory as your &lt;code>env_file&lt;/code>. File a ticket in this repository and attach this log file. To read more about the contents of the &lt;code>cht-docker-compose.log&lt;/code> see &lt;a href="#cht-docker-composelog">the CHT Docker Compose Log section&lt;/a>.&lt;/p>
&lt;h4 id="running-without-the-ip-utility">Running without the &lt;code>ip&lt;/code> utility&lt;/h4>
&lt;p>If you&amp;rsquo;re on macOS, or other OS without the &lt;code>ip&lt;/code> utility, your IP address will always show as &lt;code>127.0.0.1&lt;/code>. You can not connect to this IP from a mobile client on your LAN because it always references the host it&amp;rsquo;s on, not a foreign host.&lt;/p>
&lt;p>To work around this, you can find out your IP on your LAN and just replace the &lt;code>127-0-0-1&lt;/code> part of the &lt;code>https://127-0-0-1.my.local-ip.co:8443&lt;/code> URL to be your IP address. So if your local IP was &lt;code>192.168.0.22&lt;/code> your URL would be &lt;code>https://192-168-0-22.my.local-ip.co:8443&lt;/code>.&lt;/p>
&lt;h4 id="booting-with-no-connectivity">Booting with no connectivity&lt;/h4>
&lt;p>This script can work without connectivity after the initial boot. However, it needs connectivity to do DNS lookups for the *.my.local-ip.co URLs. To work around this, when you have no connectivity, add an entry in your &lt;code>/etc/hosts&lt;/code> for the URL showing up in the script. For example, if you&amp;rsquo;re seeing &lt;code>https://127-0-0-1.my.local-ip.co:8443&lt;/code> as your IP, add this line to the top of your &lt;code>/etc/hosts&lt;/code> file.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>127.0.0.1 127-0-0-1.my.local-ip.co
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>&lt;strong>NOTE&lt;/strong>&lt;/em> - You need connectivity on the initial boot of the VM to connect to &lt;code>staging.dev.medicmobile.org&lt;/code> to download the base version of the CHT. As well, certificates for &lt;code>*.my.local-ip.co&lt;/code> are downloaded. Subsequent boots do not require connectivity as long as you do not run &lt;code>destroy&lt;/code>.&lt;/p>
&lt;h4 id="port-conflicts">Port conflicts&lt;/h4>
&lt;p>If you have two &lt;code>.env_docker&lt;/code> files that have the same ports or re-use the same project name, bad things will happen. Don&amp;rsquo;t do this.&lt;/p>
&lt;p>Medic recommends setting up unique project names and unique ports for each project. Commit these &lt;code>.env_docker&lt;/code> files to your app config&amp;rsquo;s revision control so all app developers use the same &lt;code>.env_docker&lt;/code> files.&lt;/p>
&lt;h4 id="slow-downloads-and-wait-periods">Slow downloads and wait periods&lt;/h4>
&lt;p>During testing on an Internet connection with high latency (&amp;gt;1000ms) and packet loss, this script had trouble booting the CHT instance because it was taking too long to download the assets from &lt;code>staging.dev.medicmobile.org&lt;/code>. Each version is about 38Â MB.&lt;/p>
&lt;p>To account for this, the wait time is multiplied times the boot iteration for each time it reboots. It starts at 100 seconds and then 200, 300, 400 up to the fifth time it will wait 500 seconds.&lt;/p>
&lt;h4 id="too-many-containers">Too many containers&lt;/h4>
&lt;p>If you&amp;rsquo;re on a resource constrained computer, like a very old or very slow laptop, be sure to watch the total number of containers you&amp;rsquo;re running. More than one or two projects (2 or 4 containers) and you may notice a slow-down. You can use the &lt;code>./docker-status.sh&lt;/code> script if you forgot which projects you have running:&lt;/p>
&lt;p>&lt;img src="docker-status.png" alt="The docker-status.sh script showing 4 sections. The top section lists the running CHT containers, their IP, their mapped ports and the state (running time). The second section found on the left is a list of docker networks. The third section is on the top right and lists downloaded docker images. The furth section on the bottom right, shows docker volumes">&lt;/p>
&lt;p>A word of caution though - for now this script doesn&amp;rsquo;t scale well if you have 10s of containers and volumes. Content &lt;a href="https://user-images.githubusercontent.com/1608415/137566806-e13b765e-4f95-48be-82e7-c8e6351e14b7.mp4">can scroll off the screen&lt;/a> and seem confusing!&lt;/p>
&lt;h4 id="output-on-macos-is-too-narrow">Output on macOS is too narrow&lt;/h4>
&lt;p>There&amp;rsquo;s a known bug with the bash library we&amp;rsquo;re using that causes it to always render at 80 characters wide. &lt;a href="https://github.com/metal3d/bashsimplecurses/issues/51#issuecomment-905914780">The fix is&lt;/a> to use &lt;code>brew&lt;/code> to run a more recent version of &lt;code>ncurses&lt;/code>.&lt;/p>
&lt;h4 id="device--does-not-exist-and-curl-6-could-not-resolve-host-errors">&amp;ldquo;Device &amp;rsquo;&amp;rsquo; does not exist&amp;rsquo;&amp;rdquo; and &amp;ldquo;curl: (6) Could not resolve host&amp;rdquo; errors&lt;/h4>
&lt;p>If you see either of these errors, you&amp;rsquo;re very likely off-line such that you effectively cannot reach the Internet. The script will not work as is. See the &amp;ldquo;Booting with no connectivity&amp;rdquo; section above for work-arounds.&lt;/p>
&lt;h4 id="resetting-everything">Resetting everything&lt;/h4>
&lt;p>If you REALLY get stuck and want to destroy &lt;em>&lt;strong>ALL&lt;/strong>&lt;/em> docker containers/volumes/networks, even those not started by this script, run this (but be &lt;em>&lt;strong>extra&lt;/strong>&lt;/em> sure that&amp;rsquo;s what you want to do):&lt;/p>
&lt;pre tabindex="0">&lt;code>docker stop $(docker ps -q)&amp;amp;&amp;amp;docker system prune&amp;amp;&amp;amp;docker volume prune
&lt;/code>&lt;/pre>&lt;h3 id="cht-docker-composelog">cht-docker-compose.log&lt;/h3>
&lt;p>This log will be output every time you call the script. It will be created and appended to in the directory where you specified your environment file (&lt;code>-e PATH/TO/env_file&lt;/code>).&lt;/p>
&lt;p>There are three types of lines in this file. The first line will always be the Start line: &lt;code>item=&amp;quot;start&amp;quot;&lt;/code>. Then there will be a Status line: &lt;code>item=&amp;quot;status&amp;quot;&lt;/code>. Finally, there will be two lines, one for each docker container: &lt;code>item=&amp;quot;docker_logs&amp;quot;&lt;/code>.&lt;/p>
&lt;h4 id="shared-head">Shared head&lt;/h4>
&lt;p>All lines start with a date, PID and count:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name in log&lt;/th>
&lt;th>Note&lt;/th>
&lt;th>Example&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>(none - first item)&lt;/td>
&lt;td>value from &lt;code>date&lt;/code> command with &lt;code>DAY DATE MONTH YEAR TIME AM/PM&lt;/code>&lt;/td>
&lt;td>&lt;code>Fri 15 Oct 2021 02:19:30 PM&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pid&lt;/code>&lt;/td>
&lt;td>process ID of the shell script. Will always be an integer&lt;/td>
&lt;td>&lt;code>398399&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>count&lt;/code>&lt;/td>
&lt;td>how many times the shell script has looped internally&lt;/td>
&lt;td>&lt;code>2&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="item--start">item = &lt;code>start&lt;/code>&lt;/h4>
&lt;p>When you first call the script, a line is output with generic information about the project. This is only shown once per call:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name in log&lt;/th>
&lt;th>Note&lt;/th>
&lt;th>Example(s)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>item&lt;/code>&lt;/td>
&lt;td>which log item this is&lt;/td>
&lt;td>&lt;code>start&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>URL&lt;/code>&lt;/td>
&lt;td>the full URL of the instance, with port&lt;/td>
&lt;td>&lt;code>https://192-168-68-17.my.local-ip.co:443&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>IP&lt;/code>&lt;/td>
&lt;td>the IP address of the instance&lt;/td>
&lt;td>&lt;code>192.168.68.17&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>port_https&lt;/code>&lt;/td>
&lt;td>port used for &lt;code>https&lt;/code>&lt;/td>
&lt;td>&lt;code>443&lt;/code> or &lt;code>8443&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>port_http&lt;/code>&lt;/td>
&lt;td>port used for &lt;code>http&lt;/code>&lt;/td>
&lt;td>&lt;code>80&lt;/code> or &lt;code>8080&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>project_name&lt;/code>&lt;/td>
&lt;td>The user specified project name. This will be used in docker container and volume names&lt;/td>
&lt;td>&lt;code>helper_test&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>total_containers&lt;/code>&lt;/td>
&lt;td>Total docker containers running on the host. Useful for catching high load scenarios. Healthy is under &lt;code>10&lt;/code>.&lt;/td>
&lt;td>&lt;code>2&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="item--status">item = &lt;code>status&lt;/code>&lt;/h4>
&lt;p>For each internal loop of the script, each one taking 1-5 seconds, a status line is output:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name in log&lt;/th>
&lt;th>Note&lt;/th>
&lt;th>Example(s)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>item&lt;/code>&lt;/td>
&lt;td>which log item this is&lt;/td>
&lt;td>&lt;code>status&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>CHT_count&lt;/code>&lt;/td>
&lt;td>number of CHT contianers running for this project. Healthy is &lt;code>2&lt;/code>&lt;/td>
&lt;td>&lt;code>2&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>port_stat&lt;/code>&lt;/td>
&lt;td>Status of the &lt;code>https&lt;/code> port. Healhty is &lt;code>open&lt;/code>&lt;/td>
&lt;td>&lt;code>open&lt;/code> or &lt;code>closed&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>http_code&lt;/code>&lt;/td>
&lt;td>If the &lt;code>https&lt;/code> port is open by the web server, what &lt;code>HTTP&lt;/code> response code is returned for a &lt;code>GET&lt;/code>. Healthy is &lt;code>200&lt;/code>. If you see &lt;code>000&lt;/code>, &lt;a href="#booting-with-no-connectivity">see workarounds&lt;/a>.&lt;/td>
&lt;td>&lt;code>200&lt;/code> or &lt;code>404&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>ssl_verify&lt;/code>&lt;/td>
&lt;td>If the &lt;code>https&lt;/code> port is open by the web server, is the valid &lt;code>local-ip.co&lt;/code> certificate installed. Healthy is &lt;code>yes&lt;/code>&lt;/td>
&lt;td>&lt;code>yes&lt;/code> or &lt;code>no&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>reboot_count&lt;/code>&lt;/td>
&lt;td>How many times &lt;code>docker restart&lt;/code> has been called. Max is &lt;code>5&lt;/code>&lt;/td>
&lt;td>&lt;code>3&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>docker_call&lt;/code>&lt;/td>
&lt;td>The docker action call to the script&lt;/td>
&lt;td>&lt;code>up&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>last_msg&lt;/code>&lt;/td>
&lt;td>Last message the user was shown&lt;/td>
&lt;td>&lt;code>Running &amp;quot;down&amp;quot; then &amp;quot;up&amp;quot;&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>load_now&lt;/code>&lt;/td>
&lt;td>Load average for the past minute. Healthy can vary, but should be &amp;lt; &lt;code>10&lt;/code>&lt;/td>
&lt;td>&lt;code>2.66&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>*_haproxy_1&lt;/code>&lt;/td>
&lt;td>Name of container based on &lt;code>project_name&lt;/code>. Showing the &amp;ldquo;has booted&amp;rdquo; status, healthy is &lt;code>true&lt;/code>&lt;/td>
&lt;td>&lt;code>false&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>*_medic-os_1&lt;/code>&lt;/td>
&lt;td>Name of container based on &lt;code>project_name&lt;/code>. Showing the &amp;ldquo;has booted&amp;rdquo; status, healthy is &lt;code>true&lt;/code>&lt;/td>
&lt;td>&lt;code>false&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="item--docker_logs">item = &lt;code>docker_logs&lt;/code>&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name in log&lt;/th>
&lt;th>Note&lt;/th>
&lt;th>Example(s)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>item&lt;/code>&lt;/td>
&lt;td>which log item this is&lt;/td>
&lt;td>&lt;code>docker_logs&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>container&lt;/code>&lt;/td>
&lt;td>Container name based on &lt;code>project_name&lt;/code>&lt;/td>
&lt;td>&lt;code>helper_test_medic-os_1&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>processes&lt;/code>&lt;/td>
&lt;td>Number of process running in the container. Medic OS should have 60-90, Nginx 4-10&lt;/td>
&lt;td>&lt;code>64&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>last_log&lt;/code>&lt;/td>
&lt;td>Result from calling &lt;code>docker logs&lt;/code> on the container. Will never have &lt;code>&amp;quot;&lt;/code> in them and date may differ from start of line date&lt;/td>
&lt;td>&lt;code>[2021/10/15 19:53:39] Info: Horticulturalist has already bootstrapped&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="sample">Sample&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>Fri &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">2021&lt;/span> 02:30:26 PM PDT &lt;span style="color:#000">pid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;410066&amp;#34;&lt;/span> &lt;span style="color:#000">count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;1&amp;#34;&lt;/span> &lt;span style="color:#000">item&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;start&amp;#34;&lt;/span> &lt;span style="color:#000">URL&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;https://192-168-68-17.my.local-ip.co:443&amp;#34;&lt;/span> &lt;span style="color:#000">IP&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;192.168.68.17&amp;#34;&lt;/span> &lt;span style="color:#000">port_https&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;443&amp;#34;&lt;/span> &lt;span style="color:#000">port_http&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;80&amp;#34;&lt;/span> &lt;span style="color:#000">project_name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;helper_test&amp;#34;&lt;/span> &lt;span style="color:#000">total_containers&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Fri &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">2021&lt;/span> 02:30:26 PM PDT &lt;span style="color:#000">pid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;410066&amp;#34;&lt;/span> &lt;span style="color:#000">count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;1&amp;#34;&lt;/span> &lt;span style="color:#000">item&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;docker_logs&amp;#34;&lt;/span> &lt;span style="color:#000">container&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;helper_test_medic-os_1&amp;#34;&lt;/span> &lt;span style="color:#000">processes&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;64&amp;#34;&lt;/span> &lt;span style="color:#000">last_log&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;[2021/10/15 19:53:39] Info: Horticulturalist has already bootstrapped&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Fri &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">2021&lt;/span> 02:30:26 PM PDT &lt;span style="color:#000">pid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;410066&amp;#34;&lt;/span> &lt;span style="color:#000">count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;1&amp;#34;&lt;/span> &lt;span style="color:#000">item&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;docker_logs&amp;#34;&lt;/span> &lt;span style="color:#000">container&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;helper_test_haproxy_1&amp;#34;&lt;/span> &lt;span style="color:#000">processes&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;4&amp;#34;&lt;/span> &lt;span style="color:#000">last_log&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;Oct 15 21:30:20 576ca039cd88 haproxy[25]: 172.20.0.3,200,GET,/medic/_design/medic,-,medic,&amp;#39;-&amp;#39;,21703,5,21402,&amp;#39;curl/7.68.0&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Fri &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">2021&lt;/span> 02:30:26 PM PDT &lt;span style="color:#000">pid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;410066&amp;#34;&lt;/span> &lt;span style="color:#000">count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;1&amp;#34;&lt;/span> &lt;span style="color:#000">item&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;status&amp;#34;&lt;/span> &lt;span style="color:#000">CHT_count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;2&amp;#34;&lt;/span> &lt;span style="color:#000">port_stat&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;open&amp;#34;&lt;/span> &lt;span style="color:#000">http_code&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;200&amp;#34;&lt;/span> &lt;span style="color:#000">ssl_verify&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;yes&amp;#34;&lt;/span> &lt;span style="color:#000">reboot_count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;0&amp;#34;&lt;/span> &lt;span style="color:#000">docker_call&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;up&amp;#34;&lt;/span> &lt;span style="color:#000">last_msg&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;Initializing&amp;#34;&lt;/span> &lt;span style="color:#000">load_now&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;2.66&amp;#34;&lt;/span> &lt;span style="color:#000">helper_test_haproxy_1&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span> helper_test_medic-os_1&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Fri &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">2021&lt;/span> 02:30:28 PM PDT &lt;span style="color:#000">pid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;410066&amp;#34;&lt;/span> &lt;span style="color:#000">count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;2&amp;#34;&lt;/span> &lt;span style="color:#000">item&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;docker_logs&amp;#34;&lt;/span> &lt;span style="color:#000">container&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;helper_test_medic-os_1&amp;#34;&lt;/span> &lt;span style="color:#000">processes&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;67&amp;#34;&lt;/span> &lt;span style="color:#000">last_log&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;[2021/10/15 19:53:39] Info: Horticulturalist has already bootstrapped&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Fri &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">2021&lt;/span> 02:30:28 PM PDT &lt;span style="color:#000">pid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;410066&amp;#34;&lt;/span> &lt;span style="color:#000">count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;2&amp;#34;&lt;/span> &lt;span style="color:#000">item&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;docker_logs&amp;#34;&lt;/span> &lt;span style="color:#000">container&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;helper_test_haproxy_1&amp;#34;&lt;/span> &lt;span style="color:#000">processes&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;4&amp;#34;&lt;/span> &lt;span style="color:#000">last_log&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;Oct 15 21:30:27 576ca039cd88 haproxy[25]: 172.20.0.3,200,GET,/medic/_design/medic,-,medic,&amp;#39;-&amp;#39;,21703,5,21402,&amp;#39;curl/7.68.0&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Fri &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">2021&lt;/span> 02:30:28 PM PDT &lt;span style="color:#000">pid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;410066&amp;#34;&lt;/span> &lt;span style="color:#000">count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;2&amp;#34;&lt;/span> &lt;span style="color:#000">item&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;status&amp;#34;&lt;/span> &lt;span style="color:#000">CHT_count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;2&amp;#34;&lt;/span> &lt;span style="color:#000">port_stat&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;open&amp;#34;&lt;/span> &lt;span style="color:#000">http_code&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;200&amp;#34;&lt;/span> &lt;span style="color:#000">ssl_verify&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;yes&amp;#34;&lt;/span> &lt;span style="color:#000">reboot_count&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;0&amp;#34;&lt;/span> &lt;span style="color:#000">docker_call&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;up&amp;#34;&lt;/span> &lt;span style="color:#000">last_msg&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34; :) &amp;#34;&lt;/span> &lt;span style="color:#000">load_now&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;2.69&amp;#34;&lt;/span> &lt;span style="color:#000">helper_test_haproxy_1&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span> helper_test_medic-os_1&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="cookie-collisions">Cookie collisions&lt;/h2>
&lt;p>The CHT stores its cookies based on the domain. This means if you&amp;rsquo;re running two concurrent instances on &lt;code>https://192-168-68-40.my.local-ip.co:8443&lt;/code> and &lt;code>https://192-168-68-40.my.local-ip.co:8440&lt;/code> (note different ports), the CHT would write the cookie under the same &lt;code>192-168-68-40.my.local-ip.co&lt;/code> domain. When logging out of one instance, you would get logged out of both and other consistencies.&lt;/p>
&lt;p>To avoid this collision of cookies, you can use different IP addresses to access the instances. This works because of two reasons:&lt;/p>
&lt;ol>
&lt;li>the TLS certificate being used is valid for any subdomain of &lt;code>*.my.local-ip.co&lt;/code>. Further, the URL always resolves to the IP passed in the &lt;code>*&lt;/code> section, so you can use any IP&lt;/li>
&lt;li>the IPs that are available to reference your &lt;code>localhost&lt;/code> are actually a &lt;code>/8&lt;/code> netmask, meaning &lt;a href="https://en.wikipedia.org/wiki/Localhost#Name_resolution">there are 16 million addresses&lt;/a> to choose from!&lt;/li>
&lt;/ol>
&lt;p>Using the above two reasons, these URLs could work to avoid the cookie collision:&lt;/p>
&lt;ul>
&lt;li>&lt;code>https://127-0-0-1.my.local-ip.co:8443&lt;/code>&lt;/li>
&lt;li>&lt;code>https://127-0-0-2.my.local-ip.co:8440&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>This would result in the domains being &lt;code>127.0.0.1&lt;/code> and &lt;code>127.0.0.2&lt;/code> from the CHT&amp;rsquo;s perspective. When using a mobile device for testing, you&amp;rsquo;re limited to use the LAN ip output in the helper and can not use the &lt;code>127.x.x.x&lt;/code> IPs.&lt;/p></description></item><item><title>Apps: CHT Core Developer Setup</title><link>https://docs.communityhealthtoolkit.org/apps/guides/hosting/core-developer/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/apps/guides/hosting/core-developer/</guid><description>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">Note&lt;/h4>
&lt;p>This guide assumes you are a CHT Core developer wanting to run the CHT Core from source code to make commits to the &lt;a href="https://github.com/medic/cht-core">public GitHub repository&lt;/a>. To set up a your environment for developing apps, see the &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/app-developer/">app guide&lt;/a>.&lt;/p>
&lt;p>To deploy the CHT in production, see either &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/self-hosting/">AWS hosting&lt;/a> or &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/ec2-setup-guide/">Self hosting&lt;/a>&lt;/p>
&lt;/div>
&lt;h2 id="the-happy-path-installation">The Happy Path Installation&lt;/h2>
&lt;p>This CHT Core developer guide will have you install NodeJS, npm, Grunt and CouchDB (via Docker) on your local workstation. These instructions should work verbatim on Ubuntu 18-22, but will need tweaks for MacOS (via &lt;code>brew&lt;/code>) or Windows (via WSL2).&lt;/p>
&lt;h3 id="install-nodejs-npm-grunt-and-docker">Install NodeJS, npm, grunt and Docker&lt;/h3>
&lt;p>First, update your current Ubuntu packages and install some supporting tools via &lt;code>apt&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo apt update &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> sudo apt -y dist-upgrade
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo apt -y install xsltproc curl uidmap jq python2 git
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then install &lt;code>nvm&lt;/code>, add it to your path and install NodeJS 12:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">nvm_version&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">`&lt;/span>curl -s https://api.github.com/repos/nvm-sh/nvm/releases/latest &lt;span style="color:#000;font-weight:bold">|&lt;/span> jq -r .name&lt;span style="color:#4e9a06">`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/&lt;span style="color:#000">$nvm_version&lt;/span>/install.sh &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000">$0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>. ~/.&lt;span style="color:#000">$0&lt;/span>rc
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>nvm install &lt;span style="color:#0000cf;font-weight:bold">12&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now let&amp;rsquo;s ensure NodeJS 12 and npm 6 were installed. This should output version 12.x.x for NodeJS and 6.x.x for &lt;code>npm&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>node -v &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> npm -v
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>With NodeJS out of the way, let&amp;rsquo;s install &lt;code>grunt&lt;/code> via &lt;code>npm&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>npm install -g grunt-cli
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Install Docker:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>curl -fsSL get.docker.com -o get-docker.sh &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> sh get-docker.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It&amp;rsquo;s easier if you don&amp;rsquo;t always have to run &lt;code>sudo&lt;/code> for all your Docker calls, so let&amp;rsquo;s set that up:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>dockerd-rootless-setuptool.sh install
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;export PATH=/usr/bin:&lt;/span>&lt;span style="color:#000">$PATH&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span> &amp;gt;&amp;gt; ~/.&lt;span style="color:#000">$0&lt;/span>rc
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;export DOCKER_HOST=unix:///run/user/1000/docker.sock&amp;#34;&lt;/span> &amp;gt;&amp;gt; ~/.&lt;span style="color:#000">$0&lt;/span>rc
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>. ~/.&lt;span style="color:#000">$0&lt;/span>rc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In order for Docker to boot correctly, restart entire machine, which will complete the &amp;ldquo;Install&amp;rdquo; Section:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo reboot
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="couchdb-setup-in-docker">CouchDB Setup in Docker&lt;/h3>
&lt;p>Before we get started, let&amp;rsquo;s run the simple &lt;code>hello-world&lt;/code> Docker container. This will ensure docker is working as expected and output &amp;ldquo;Hello from Docker!&amp;rdquo; as well as some other intro text:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>docker run hello-world
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now that we know Docker is set up, let&amp;rsquo;s start our CouchDB container. Note this will run in the background and store its data in &lt;code>/home/YOUR-USER/cht-docker&lt;/code>. The login for your CHT instance will be &lt;code>medic&lt;/code> and the password will be &lt;code>password&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>docker run -d -p 5984:5984 -p 5986:5986 --name medic-couchdb -e &lt;span style="color:#000">COUCHDB_USER&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>medic -e &lt;span style="color:#000">COUCHDB_PASSWORD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>password -v ~/cht-docker/local.d:/opt/couchdb/data -v ~/cht-docker/local.d:/opt/couchdb/etc/local.d apache/couchdb:2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Let&amp;rsquo;s ensure CouchDB is set up with a test &lt;code>curl&lt;/code> call. This should show &amp;ldquo;nonode@nohost&amp;rdquo; in JSON:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>curl -X GET &lt;span style="color:#4e9a06">&amp;#34;http://medic:password@localhost:5984/_membership&amp;#34;&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> jq
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Every time you run any &lt;code>grunt&lt;/code> or &lt;code>node&lt;/code> commands, it will expect &lt;code>COUCH_NODE_NAME&lt;/code> and &lt;code>COUCH_URL&lt;/code> environment variables to be set:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;export COUCH_NODE_NAME=nonode@nohost&amp;#34;&lt;/span>&amp;gt;&amp;gt; ~/.&lt;span style="color:#000">$0&lt;/span>rc
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;export COUCH_URL=http://medic:password@localhost:5984/medic&amp;#34;&lt;/span>&amp;gt;&amp;gt; ~/.&lt;span style="color:#000">$0&lt;/span>rc
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>. ~/.&lt;span style="color:#000">$0&lt;/span>rc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>To ensure these to exports and sourcing your rc file worked, echo the values back out. You should see &lt;code>nonode@nohost&lt;/code> and &lt;code>http://medic:password@localhost:5984/medic&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#000">$COUCH_NODE_NAME&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#000">$COUCH_URL&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="cht-core-cloning-and-setup">CHT Core Cloning and Setup&lt;/h3>
&lt;p>Clone the main CHT Core repo from GitHub and change directories into it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>git clone https://github.com/medic/cht-core ~/cht-core
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">cd&lt;/span> ~/cht-core
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Install dependencies and perform other setup tasks via an &lt;code>npm&lt;/code> command. Note this command may take many minutes. Be patient!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>npm ci
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We need to harden couch with a &lt;code>grunt&lt;/code> call, required even in development:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>grunt secure-couchdb
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>curl -X PUT &lt;span style="color:#4e9a06">&amp;#34;http://medic:password@localhost:5984/_node/&lt;/span>&lt;span style="color:#000">$COUCH_NODE_NAME&lt;/span>&lt;span style="color:#4e9a06">/_config/httpd/WWW-Authenticate&amp;#34;&lt;/span> -d &lt;span style="color:#4e9a06">&amp;#39;&amp;#34;Basic realm=\&amp;#34;administrator\&amp;#34;&amp;#34;&amp;#39;&lt;/span> -H &lt;span style="color:#4e9a06">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="developing">Developing&lt;/h3>
&lt;p>Now you have everything installed and can begin development! You&amp;rsquo;ll need three separate terminals when doing development. In the first terminal, run:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">cd&lt;/span> ~/cht-core &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> grunt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Be &lt;strong>very&lt;/strong> patient until you see:&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;Waiting&amp;hellip;&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>Then in a 2nd terminal run:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">cd&lt;/span> ~/cht-core &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> grunt dev-api
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Finally, in a 3rd terminal run:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">cd&lt;/span> ~/cht-core &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> grunt dev-sentinel
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>That&amp;rsquo;s it! Now when you edit code in your IDE, it will automatically reload. You can see the CHT running locally here: &lt;a href="http://localhost:5988/">http://localhost:5988/&lt;/a>&lt;/p>
&lt;p>When you&amp;rsquo;re done with development you can &lt;code>ctrl + c&lt;/code> in the three terminals and stop the CouchDB container with &lt;code>docker stop medic-couchdb&lt;/code>. When you want to resume development later, run &lt;code>docker start medic-couchdb&lt;/code> and re-run the three terminal commands.&lt;/p>
&lt;h2 id="other-path-troubleshooting">Other Path Troubleshooting&lt;/h2>
&lt;p>If you weren&amp;rsquo;t able to follow &lt;a href="#the-happy-path-installation">the happy path above&lt;/a>, here are some details about the developer install that may help you troubleshoot what went wrong.&lt;/p>
&lt;h3 id="prerequisites">Prerequisites&lt;/h3>
&lt;p>If you had issues with following the above steps, check out these links for how to install the prerequisites on your specific platform:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://nodejs.org/">Node.js 12.x&lt;/a> &amp;amp; &lt;a href="https://npmjs.com/">npm 6.x.x&lt;/a> - Both of which we recommend installing [via &lt;code>nvm&lt;/code>](&lt;a href="https://npmjs.com/">npm 6.x.x&lt;/a>)&lt;/li>
&lt;li>&lt;a href="https://gruntjs.com/using-the-cli">grunt cli&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.sagehill.net/docbookxsl/InstallingAProcessor.html">xsltproc&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.python.org/downloads/">python 2.7&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.docker.com/engine/install/">Docker&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.couchdb.org/en/2.3.1/install/index.html">CouchDB&lt;/a> - OS package instead of in Docker - you &lt;strong>MUST&lt;/strong> use CouchDB 2.x! We still strongly recommend using Docker.&lt;/li>
&lt;/ul>
&lt;h3 id="couchdb-on-docker-details">CouchDB on Docker Details&lt;/h3>
&lt;p>Breaking down the command from &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/core-developer/#couchdb-setup-in-docker">the above section&lt;/a>, here&amp;rsquo;s a generic version that doesn&amp;rsquo;t include hard coded paths:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>docker run -d -p 5984:5984 -p 5986:5986 --name medic-couchdb -e &lt;span style="color:#000">COUCHDB_USER&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>medic -e &lt;span style="color:#000">COUCHDB_PASSWORD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>password -v &amp;lt;data path&amp;gt;:/opt/couchdb/data -v &amp;lt;config path&amp;gt;:/opt/couchdb/etc/local.d apache/couchdb:2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Parts of the command:&lt;/p>
&lt;ul>
&lt;li>&lt;code>--name&lt;/code> creates a container called &lt;code>medic-couchdb&lt;/code>. You can name it whatever you want, but this is how you refer to it later&lt;/li>
&lt;li>&lt;code>-e&lt;/code> sets an environment variable inside the container. Two are set here, for a user and password for the initial admin user.&lt;/li>
&lt;li>&lt;code>-v&lt;/code> maps where couchdb stores data to your local file system to ensure persistence without depending on the container, using the path &lt;em>before&lt;/em> the &lt;code>:&lt;/code> (the path after the colon is the internal path inside the docker image). This should be somewhere you have write access to, and want this data to be stored. The second mounted volume is for the couch configuration, which will retain settings if your container is removed. This is especially important after running the command to secure the instance (done in steps below).&lt;/li>
&lt;li>&lt;code>apache/couchdb:2&lt;/code> will install the latest package for CouchDB 2.x&lt;/li>
&lt;/ul>
&lt;p>Once this downloads and starts, you will need to &lt;a href="http://localhost:5984/_utils/#/setup">initialise CouchDB&lt;/a> as noted in &lt;a href="https://docs.couchdb.org/en/2.3.1/setup/index.html#setup">their install instructions&lt;/a>.&lt;/p>
&lt;p>You can use &lt;code>docker stop medic-couchdb&lt;/code> to stop it and &lt;code>docker start medic-couchdb&lt;/code> to start it again. Remember that you&amp;rsquo;ll need to start it whenever you restart your OS, which might not be the case if you use a normal OS package. &lt;code>docker rm medic-couchdb&lt;/code> will totally remove the container.&lt;/p>
&lt;p>Medic recommends you familiarise yourself with other Docker commands to make docker image and container management clearer.&lt;/p>
&lt;h3 id="required-environment-variables">Required environment variables&lt;/h3>
&lt;p>Medic needs the following environment variables to be declared:&lt;/p>
&lt;ul>
&lt;li>&lt;code>COUCH_URL&lt;/code>: the full authenticated url to the &lt;code>medic&lt;/code> DB. Locally this would be &lt;code>http://myadminuser:myadminpass@localhost:5984/medic&lt;/code>&lt;/li>
&lt;li>&lt;code>COUCH_NODE_NAME&lt;/code>: the name of your CouchDB&amp;rsquo;s node. The Docker image default is &lt;code>nonode@nohost&lt;/code>. Other installations may use &lt;code>couchdb@127.0.0.1&lt;/code>. You can find out by querying &lt;a href="https://docs.couchdb.org/en/stable/api/server/common.html#membership">CouchDB&amp;rsquo;s membership API&lt;/a>&lt;/li>
&lt;li>(optionally) &lt;code>API_PORT&lt;/code>: the port API will run on. If not defined we use &lt;code>5988&lt;/code>&lt;/li>
&lt;li>(optionally) &lt;code>CHROME_BIN&lt;/code>: only required if &lt;code>grunt unit&lt;/code> or &lt;code>grunt e2e&lt;/code> complain that they can&amp;rsquo;t find Chrome or if you want to run a specific version of the Chrome webdriver.&lt;/li>
&lt;/ul>
&lt;p>How to permanently define environment variables depends on your OS and shell (e.g. for bash you can put them &lt;code>~/.bashrc&lt;/code>). You can temporarily define them with &lt;code>export&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">COUCH_NODE_NAME&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>nonode@nohost
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">COUCH_URL&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>http://myadminuser:myadminpass@localhost:5984/medic
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="tests">Tests&lt;/h2>
&lt;p>Refer to &lt;a href="https://github.com/medic/cht-core/blob/master/TESTING.md">the testing doc&lt;/a> in the GitHub repo.&lt;/p>
&lt;h2 id="nginx-local-ip">nginx-local-ip&lt;/h2>
&lt;p>&lt;a href="https://github.com/medic/nginx-local-ip">&lt;code>nginx-local-ip&lt;/code>&lt;/a> is a local proxy that keeps all traffic local, and runs without latency or throttling. If sharing your local CHT instance is not required, it is the recommended method to add a valid SSL certificate (rather than &lt;code>ngrok&lt;/code> or similar).&lt;/p>
&lt;ol>
&lt;li>Clone the repo: &lt;code>git clone https://github.com/medic/nginx-local-ip.git&lt;/code>&lt;/li>
&lt;li>&lt;code>cd&lt;/code> into the new directory: &lt;code>cd nginx-local-ip&lt;/code>&lt;/li>
&lt;li>Assuming your IP is &lt;code>192.168.0.3&lt;/code>, start &lt;code>nginx-local-ip&lt;/code> to connect to:
&lt;ul>
&lt;li>The CHT API running via &lt;code>grunt&lt;/code> or &lt;code>horti&lt;/code>, execute &lt;code>APP_URL=http://192.168.0.3:5988 docker compose up&lt;/code> and then access it at &lt;a href="https://192-168-0-3.my.local-ip.co/">https://192-168-0-3.my.local-ip.co/&lt;/a>&lt;/li>
&lt;li>The CHT API running via &lt;code>docker&lt;/code>, the ports are remapped, so execute &lt;code>HTTP=8080 HTTPS=8443 APP_URL=https://192.168.0.3 docker compose up&lt;/code> and then access it at &lt;a href="https://192-168-0-3.my.local-ip.co:8443/">https://192-168-0-3.my.local-ip.co:8443/&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>The HTTP/HTTPS ports (&lt;code>80&lt;/code>/&lt;code>443&lt;/code>) need to accept traffic from the IP address of your host machine and your local webapp port (e.g. &lt;code>5988&lt;/code>) needs to accept traffic from the IP address of the &lt;code>nginx-local-ip&lt;/code> container (on the Docker network). If you are using the UFW firewall (in a Linux environment) you can allow traffic on these ports with the following commands:&lt;/li>
&lt;/ol>
&lt;p>(Since local IP addresses can change over time, ranges are used in these rules so that the firewall configuration does not have to be updated each time a new address is assigned.)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo ufw allow proto tcp from 192.168.0.0/16 to any port 80,443
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo ufw allow proto tcp from 172.16.0.0/16 to any port &lt;span style="color:#0000cf;font-weight:bold">5988&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="remote-proxies">Remote Proxies&lt;/h2>
&lt;p>&lt;code>ngrok&lt;/code> and &lt;code>pagekite&lt;/code> are remote proxies that route local traffic between your client and the CHT via a remote SSL terminator. While easy and handy, they introduce latency and are sometimes throttled. Always use &lt;code>nginx-local-ip&lt;/code> when you need a TLS certificate and only use these when you need to share your dev instance.&lt;/p>
&lt;h3 id="ngrok">ngrok&lt;/h3>
&lt;ol>
&lt;li>Create an &lt;a href="https://ngrok.com/">ngrok account&lt;/a>, download and install the binary, then link your computer to your ngrok account.&lt;/li>
&lt;li>Start &lt;code>ngrok&lt;/code> to connect to:
&lt;ul>
&lt;li>The CHT API running via &lt;code>grunt&lt;/code> or &lt;code>horti&lt;/code>, execute &lt;code>./ngrok http 5988&lt;/code>&lt;/li>
&lt;li>The CHT API running via &lt;code>docker&lt;/code>, execute &lt;code>./ngrok http 443&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Access the app using the https address shown (e.g. &lt;code>https://YOUR-NGROK-NAME.ngrok.io&lt;/code>, replacing &lt;code>YOUR-NGROK-NAME&lt;/code> with what you signed up with).&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>Note:&lt;/strong> The service worker cache preload sometimes fails due to connection throttling (thereby causing an &lt;code>ngrok&lt;/code> failure at startup).&lt;/p>
&lt;h3 id="pagekite">pagekite&lt;/h3>
&lt;ol>
&lt;li>Create a &lt;a href="https://pagekite.net/signup/">pagekite account&lt;/a>, download and install the python script.&lt;/li>
&lt;li>Start pagekite (be sure to replace &lt;code>YOUR-PAGEKIT-NAME&lt;/code> with the URL you signed up for) to connect to:&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>The CHT API running via &lt;code>grunt&lt;/code> or &lt;code>horti&lt;/code>, execute &lt;code>python pagekite.py 5988 YOUR-PAGEKIT-NAME.pagekite.me&lt;/code>&lt;/li>
&lt;li>The CHT API running via &lt;code>docker&lt;/code>, execute &lt;code>python pagekite.py 443 YOUR-PAGEKIT-NAME.pagekite.me&lt;/code>&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>Access the app using the https address shown (e.g. &lt;code>https://YOUR-PAGEKIT-NAME.pagekite.me&lt;/code>).&lt;/li>
&lt;/ol></description></item><item><title>Apps: SSL Cert Install</title><link>https://docs.communityhealthtoolkit.org/apps/guides/hosting/ssl-cert-install/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/apps/guides/hosting/ssl-cert-install/</guid><description>
&lt;h2 id="requirements">Requirements&lt;/h2>
&lt;ul>
&lt;li>Installed CHT-Core 3.x via either &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/self-hosting/">Self Hosted&lt;/a>, &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/ec2-setup-guide/">EC2&lt;/a> or &lt;a href="https://docs.communityhealthtoolkit.org/apps/tutorials/local-setup/">Local Setup&lt;/a>, but must use &lt;code>docker-compose&lt;/code>.&lt;/li>
&lt;li>Your own SSL certifications like Let&amp;rsquo;s Encrypt.&lt;/li>
&lt;/ul>
&lt;h2 id="copy-certs-into-medic-os-container">Copy certs into medic-os container&lt;/h2>
&lt;p>On your server copy the &lt;code>.crt&lt;/code> and &lt;code>.key&lt;/code> files to the &lt;code>medic-os&lt;/code> container. The existing self signed &lt;code>.crt&lt;/code> and &lt;code>.key&lt;/code> files will be overwitten:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>sudo docker cp /path/to/ssl.crt medic-os:/srv/settings/medic-core/nginx/private/default.crt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo docker cp /path/to/ssl.key medic-os:/srv/settings/medic-core/nginx/private/default.key
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="restart-services">Restart services&lt;/h2>
&lt;p>Now that the &lt;code>.crt&lt;/code> and &lt;code>.key&lt;/code> files are in place, restart &lt;code>nginx&lt;/code> in the &lt;code>medic-os&lt;/code> container with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>docker &lt;span style="color:#204a87">exec&lt;/span> -it medic-os /boot/svc-restart medic-core nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="view-nginx-logs">View Nginx Logs&lt;/h2>
&lt;p>To troubleshoot any problems with the new certificates, after running &lt;code>docker exec -it medic-os bash&lt;/code>, the &lt;code>nginx&lt;/code> log files can be found in &lt;code>/srv/storage/medic-core/nginx/logs/&lt;/code>, including:&lt;/p>
&lt;ul>
&lt;li>access.log&lt;/li>
&lt;li>error-ssl.log&lt;/li>
&lt;li>error.log&lt;/li>
&lt;li>startup.log&lt;/li>
&lt;/ul></description></item><item><title>Apps: Offline Hosting of CHT Server</title><link>https://docs.communityhealthtoolkit.org/apps/guides/hosting/offline/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/apps/guides/hosting/offline/</guid><description>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">Note&lt;/h4>
&lt;p>This guide is not meant for a production CHT instance. Support may be added in the future an offline CHT server in a production environment. Please see the &amp;ldquo;Considerations&amp;rdquo; section below.&lt;/p>
&lt;p>Proceed only if you have staff familiar with DNS, TLS Certs, DHCP, LAN topology and Linux in general. This is a complex deployment where mistakes are easy to make unless proper training is in place.&lt;/p>
&lt;/div>
&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>The CHT is built as an &lt;a href="https://docs.communityhealthtoolkit.org/core/overview/offline-first/">Offline-First&lt;/a> application. This applies to clients, either browsers or Android applications, connecting to the CHT server. The server itself assumes it has Internet connectivity to provide services such as DNS, software updates and general use connectivity. This document explores what it looks like when the CHT server is offline without these services available.&lt;/p>
&lt;p>Running a CHT server offline requires no modifications to the CHT itself. Instead, supporting services normally found online are replicated locally.&lt;/p>
&lt;h2 id="considerations">Considerations&lt;/h2>
&lt;p>An offline CHT server is most appropriate for a development environment. There are serious implications to consider before deploying an offline instance per our &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/requirements/#considerations">existing requirements&lt;/a>.&lt;/p>
&lt;p>Additionally, if users are going to migrate between offline locations with the same domain name, always ensure different login and passwords are used for all users across instances. This will prevent a client from another CHT instance trying to synchronize with a CHT instance it shouldn&amp;rsquo;t synchronize with, possibly causing data corruption or privacy issues through unintended data access.&lt;/p>
&lt;h2 id="requirements">Requirements&lt;/h2>
&lt;p>A CHT instance is accessible offline when you can resolve the domain to an IP address, and a TLS certificate is on the CHT server with a common name (CN) that matches the domain name. On top of the &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/requirements/">existing requirements&lt;/a>, the following aspects must also be considered.&lt;/p>
&lt;h3 id="static-ip">Static IP&lt;/h3>
&lt;p>The CHT server needs to be given a static IP so that DNS will always resolve to the correct host.&lt;/p>
&lt;h3 id="tls-certificate">TLS Certificate&lt;/h3>
&lt;p>Browsers might allow you to connect to a server with an invalid TLS certificate after you &lt;a href="https://www.ssl.com/guide/troubleshooting-ssl-tls-browser-errors-and-warnings/">bypass the warning&lt;/a>. Android apps however, like &lt;a href="https://github.com/medic/cht-android">CHT Android App&lt;/a>, require a valid TLS certificate to work correctly, therefore you would need to acquire a valid TLS certificate from a certificate authority (CA) and install it on your CHT server.&lt;/p>
&lt;p>It is common to use &lt;a href="https://en.wikipedia.org/wiki/Let%27s_encrypt">Let&amp;rsquo;s Encrypt&lt;/a> to acquire certificates because they provide free certificates. Let&amp;rsquo;s Encrypt certificates expire after 90 days, so the server will need to be constantly updated with a new certificate. Other CAs provide certificates that expire after a year, so this concern will always apply.&lt;/p>
&lt;p>After acquiring the certificate, if you are running a Docker-based CHT deployment, see &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/hosting/ssl-cert-install/">TLS instructions for Docker&lt;/a> to install the certificate.&lt;/p>
&lt;h3 id="domain-name-server">Domain Name Server&lt;/h3>
&lt;p>In order to match the static IP of the web server to the CN in the certificate, a Domain Name Server (DNS) must be used. This will allow any client on the LAN to easily connect to your CHT server without needing anything more than the domain name.&lt;/p>
&lt;p>Most LANs will defer to the Internet Service Provider (ISP) to provide DNS, but there is no ISP in an offline scenario. Instead, one must be provided. This DNS server will then be configured to have an &lt;code>A&lt;/code> record (or &lt;code>AAAA&lt;/code> in the case of IPv6) to point to the CHT server.&lt;/p>
&lt;h3 id="dynamic-host-configuration-protocol">Dynamic Host Configuration Protocol&lt;/h3>
&lt;p>Any new client that connects to a network will get an IP address from a Dynamic Host Configuration Protocol (DHCP) server. It is critical that the DHCP server for the LAN the CHT is on instructs all clients to use the DNS server configured above.&lt;/p>
&lt;h3 id="wi-fi-ap">Wi-Fi AP&lt;/h3>
&lt;p>A Wi-FI Access Point (AP) needs to be deployed on the LAN so Android devices can connect to the CHT. This can be an AP included with the router or a standalone AP. If the AP is standalone, check that any DHCP or DNS servers that could conflict with the one above are disabled.&lt;/p>
&lt;h2 id="benefits-over-other-solutions">Benefits Over Other Solutions&lt;/h2>
&lt;p>An offline deployment may consider substituting some requirements above with these other solutions. Note that ngrok and local-ip.co require Internet connectivity, so are not an offline solution.&lt;/p>
&lt;h3 id="ngrok">ngrok&lt;/h3>
&lt;p>When an offline solution is deployed, traffic stays 100% local, whereas when using either &lt;a href="https://docs.communityhealthtoolkit.org/apps/guides/debugging/secure-sharing-of-developer-instance/">your own reverse proxy&lt;/a> or a third party provider like &lt;a href="https://ngrok.com/">ngrok&lt;/a>, traffic may traverse 100s or 1,000s of kilometers to ultimately reach the CHT server which is 10 meters away. This can help when Internet connectivity is very slow, very expensive per megabyte, or both.&lt;/p>
&lt;h3 id="local-ipco">local-ip.co&lt;/h3>
&lt;p>&lt;a href="http://local-ip.co/">local-ip.co&lt;/a> offers both the TLS certificate and private key for &lt;code>*.my.local-ip.co&lt;/code>. Additionally, the service has a DNS server that dynamically maps any IP you pass in the sub-sub-domain to the real world IP such that &lt;code>192-168-0-1.my.local-ip.co&lt;/code> would resolve to &lt;code>192.168.0.1&lt;/code>. This can make it very handy to deploy a development instance where all HTTP traffic remains local (unlike &lt;code>ngrok&lt;/code> above).&lt;/p>
&lt;p>As the DNS traffic still needs to leave your network and return, it is not a viable solution for a truly offline CHT deployment.&lt;/p>
&lt;h3 id="self-signed-certificates">Self-Signed Certificates&lt;/h3>
&lt;p>Another option to consider is to &lt;a href="https://gist.github.com/anand-k-p/851e57c3aa43e1e36df164f1c215609e">self-sign the certificates&lt;/a> and then either bypass the warnings in browsers or install the new CA root certificate on your devices. While this may work for a development environment with a single developer, it will be hard to scale to an environment where you&amp;rsquo;d like to easily provision many Android devices. The work will be much more than just installing an APK form the Play Store (or the slightly harder side load process).&lt;/p>
&lt;p>This may only work on certain, older version of Android as well.&lt;/p>
&lt;h3 id="no-dhcp-or-dns-server">No DHCP or DNS Server&lt;/h3>
&lt;p>To avoid installing both the DHCP and DNS servers, an Android app that enables custom DNS entries, like &lt;a href="https://play.google.com/store/apps/details?id=com.burakgon.dnschanger">DNS Changer&lt;/a> or &lt;a href="https://play.google.com/store/apps/details?id=org.itxtech.daedalus">Daedalus&lt;/a> could be used. As &lt;a href="https://stackoverflow.com/questions/6370017/mapping-a-hostname-to-an-ip-address-on-android">seen here&lt;/a>, on each Android device you could install this and add custom DNS entries to reach the TLS certificate on the CHT.&lt;/p>
&lt;p>Like the self-signed certificate solution, this is hard to scale and would need to be complimented by editing &lt;code>/etc/hosts&lt;/code> files on desktop browsers.&lt;/p></description></item></channel></rss>